%!TEX root = ../Thesis_example_compile_this.tex

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\chapter{Case Study}
\label{ch:casestudy}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

This chapter presents the application of the complete \gls{NMR} workflow to a real \gls{3D} dataset. The \gls{NMR} workflow is designed to capture the spatial features of non‚ÄêGaussian distributions in a way that the multi-Gaussian assumption and a \gls{LMR} cannot. The case study aims to construct an \gls{NMR} spatial model and compare it to a traditional model. The dataset comes from a mineral deposit where the project operator has observed non-Gaussian characteristics within drillholes that are not well reproduced by \gls{SGS}.

The workflow consists of (1) inferring the parameters that map the latent space to the observed space with \texttt{NMROPT} and (2) imputing the latent factors at the data locations with \texttt{NMRIMP} that return the actual values when mapped. The mapping is non-linear and inferred so all desired two- and multipoint statistics are captured in the final realizations. The idea is that the \gls{NMR} realizations can capture non-Gaussian spatial features such as asymmetric indicator variograms and connectivity of extreme values. Twenty-five conditional realizations are generated with the \gls{NMR}, and pertinent model statistics are checked and compared to \gls{SGS}.

\FloatBarrier
\section{Exploratory Data Analysis}
\label{sec:eda}

The complete dataset consists of $27,983$ values nominally composited to 5 meters. All coordinates are transformed such that the spatial centroid of the data is $(x=0,y=0,z=0)$. For cross-validation purposes, approximately 30\% of the data is withheld as a `test set'. Figure \ref{fig:train_data} shows plan-view, east-west and north-south sections through the training dataset coloured by the variable of interest. The test data is not exposed to any subsequent modeling step. Figure \ref{fig:datasets} shows \glspl{CDF} and basic summary statistics for the `training' and `test' datasets. All modeling considers only the training dataset and the test set is utilized in Section \ref{sec:compare}.

\begin{figure}[htb!]
    \centering
    \includegraphics[scale=0.5, max size={\textwidth}{\textheight}]{./0-Figures/06-Ch6/test_train_cdf.png}
    \caption{ \Glspl{CDF} for training and testing datasets. }
    \label{fig:datasets}
\end{figure}

Experimental variograms are first calculated using an omni-directional search that informs the nugget effect. This search uses short lags to highlight the shape and range of the short-scale continuity. The omni-directional variogram suggests a nugget effect of near zero, and that an exponential variogram shape is appropriate for the modeled variable. Directional experimental variograms are calculated first in original units and fitted with an exponential model. Figure \ref{fig:orig_expvar} shows the fitted experimental points and Table \ref{tab:orig_expvar} shows the model parameters. The original unit variogram defines the search orientation and anisotropy for estimator-based declustering. Indicator variograms are calculated for the grade distribution's 0.1, 0.5 and 0.9 quantiles. Figures \ref{fig:ind_expvar} show the fitted indicator variogram models, and Table \ref{tab:ind_expvar} summarizes the model parameters. Interestingly, the 0.1 and 0.9 indicator variograms are not highly asymmetric with this dataset.

% \begin{table}[!htb]
%     \centering
%     \caption{Training and testing datasets.}
%     \resizebox{1\width}{!}{\input{0-Tables/variables.tex}}
%     \label{tab:datasets}
% \end{table}


% \foreach \sec/\name in \sectuples
% {
%     \begin{figure}[htb!]
%         \centering
%         \includegraphics[scale=0.5, max size={\textwidth}{\textheight}]{./0-Figures/06-Ch6/var_a_\sec.png}
%         \caption{ \name \ sections through the training dataset. }
%         \label{fig:train_\sec}
%     \end{figure}
% }

\begin{figure}
    \centering
    \tabskip=0pt
    \valign{#\cr
        \hbox{%
            \begin{subfigure}[b]{.50\textwidth}
                \centering
                \includegraphics[width=\textwidth]{./0-Figures/06-Ch6/var_a_xy.png}
                \caption{}
            \end{subfigure}%
        }\cr
        \noalign{\hfill}
        \hbox{%
            \begin{subfigure}{.50\textwidth}
                \centering
                \includegraphics[width=\textwidth]{./0-Figures/06-Ch6/var_a_xz.png}
                \caption{}
            \end{subfigure}%
        }\vfill
        \hbox{%
            \begin{subfigure}{.50\textwidth}
                \centering
                \includegraphics[width=\textwidth]{./0-Figures/06-Ch6/var_a_yz.png}
                \caption{}
            \end{subfigure}%
        }\cr
    }
    \caption{Plan (a), east-west (b) and north-south (c) sections through the training dataset.}
    \label{fig:train_data}
\end{figure}

\begin{figure}[htb!]
    \centering
    \includegraphics[scale=0.6, max size={\textwidth}{\textheight}]{./0-Figures/06-Ch6/var_a_variogram.png}
    \caption{Fitted original unit variograms in the major, minor and tertiary directions. }
    \label{fig:orig_expvar}
\end{figure}

\begin{table}[!htb]
    \centering
    \caption{Original unit variogram model parameters.}
    \resizebox{1\width}{!}{\input{0-Tables/var_a_variogram.tex}}
    \label{tab:orig_expvar}
\end{table}

\begin{figure}
    \begin{subfigure}{1.0\textwidth}
        \centering
        \includegraphics[scale=0.6, max size={\textwidth}{\textheight}]{./0-Figures/06-Ch6/var_a_ivariogram_0_1.png}
        \caption{0.1 Quantile}
    \end{subfigure}
    \begin{subfigure}{1.0\textwidth}
        \centering
        \includegraphics[scale=0.6, max size={\textwidth}{\textheight}]{./0-Figures/06-Ch6/var_a_ivariogram_0_5.png}
        \caption{0.5 Quantile}
    \end{subfigure}
    \begin{subfigure}{1.0\textwidth}
        \centering
        \includegraphics[scale=0.6, max size={\textwidth}{\textheight}]{./0-Figures/06-Ch6/var_a_ivariogram_0_9.png}
        \caption{0.9 Quantile}
    \end{subfigure}
    \caption{Fitted experimental indicator variograms for the 0.1 (a), 0.5 (b) and 0.9 (c) quantiles.}
    \label{fig:ind_expvar}
\end{figure}

\begin{table}[!htb]
    \centering
    \caption{Indicator variogram model parameters. All models have zero nugget.}
    \resizebox{0.9\width}{!}{\input{0-Tables/ivario_models.tex}}
    \label{tab:ind_expvar}
\end{table}

Transformation to Gaussian space requires a representative \gls{CDF}.  \Gls{ID2} estimation produces declustering weights. A grid of 5 x 5 x 5 meter blocks is used considering a 25-meter buffer in the x, y, and z directions around all available data (the \gls{SMU} grid). \Gls{ID2} estimation weights for each data are accumulated during an estimation run and used as declustering weights. The idea is that data in dense regions receive less total weight as many data are present in the search neighbourhood. In sparse areas, data receive more weight as fewer data are in the search neighbourhood. Estimator declustering is more robust than traditional cell declustering for irregular data configurations as the search ellipse can capture the principal orientation of continuity. The limits of the estimation grid must be well-defined to prevent unintended edge effects \citep{Wilde2007}. Figure \ref{fig:declus_cdf} shows the clustered (black) and declustered \gls{CDF} (red).

After the normal score transformation, the experimental variogram of the normal scores is calculated and fitted with a model. Figure \ref{fig:ns_expvar} shows the fitted experimental points and Table \ref{tab:ns_expvar} shows the model parameters. A normal score variogram permits the calculation of accuracy metrics, particularly the fraction of true values that fall within specified probability intervals. Figure \ref{fig:ns_xval} shows a leave-one-drillhole out cross-validation and accuracy plot for the fitted normal score variogram model. The scatter plot shows a reasonable \gls{SOR} and reproduction of the true mean. The accuracy plot suggests a reasonable space of uncertainty for the fitted model.

\begin{figure}[htb!]
    \centering
    \includegraphics[scale=0.5, max size={\textwidth}{\textheight}]{./0-Figures/06-Ch6/var_a_declus_cdf.png}
    \caption{ Declustered \gls{CDF} (red) considering \gls{ID2} weights. }
    \label{fig:declus_cdf}
\end{figure}

\begin{figure}[htb!]
    \centering
    \includegraphics[scale=0.6, max size={\textwidth}{\textheight}]{./0-Figures/06-Ch6/ns_var_a_variogram.png}
    \caption{Fitted normal score variograms in the major, minor and tertiary directions (left to right). }
    \label{fig:ns_expvar}
\end{figure}

\begin{table}[!htb]
    \centering
    \caption{Normal score variogram model parameters.}
    \resizebox{1\width}{!}{\input{0-Tables/ns_var_a_variogram.tex}}
    \label{tab:ns_expvar}
\end{table}

\begin{figure}[htb!]
    \centering
    \includegraphics[scale=0.75, max size={\textwidth}{\textheight}]{./0-Figures/06-Ch6/nsvario_xval.png}
    \caption{Normal score variogram \gls{LOOCV} (left) and accuracy plot (right).}
    \label{fig:ns_xval}
\end{figure}

The final step of \gls{EDA} is to generate a reference model for validation purposes. An exhaustive model is generated with \gls{OK} considering a minimum of 6 and a maximum of 40 composites using a search ellipse with ranges and angles aligned with the fitted original units variogram model (Table \ref{tab:orig_expvar}).

\FloatBarrier
\section{Network Parameter Inference}
\label{sec:param}

Parameterization of the \gls{NMR} requires the definition of (1) optimization targets, (2) a pool of latent Gaussian factors, (3) architecture of the network and (4) optimization hyperparameters. The continuous normal score, and indicator variograms from Section \ref{sec:eda} become optimization targets for parameterizing the \gls{NMR}. Target run distributions are calculated internally from the drillhole data by \texttt{NMROPT}.

The initial step in defining the Gaussian pool is checking how well a traditional simulation algorithm (e.g.\ \gls{SGS}) reproduces the optimization target only considering the continuous variogram. This ``base-case'' model provides insight into the required features to achieve the desired targets. \Gls{SGS} performs well reproducing the continuous and all indicator variograms, likely due to the data density of the training dataset. Though variograms are well reproduced, there is a discrepancy between downhole sequences from the data and the base-case model. Figure \ref{fig:data_sgs_runs} shows cumulative run length frequencies above the 0.9 quantile calculated directly from the data (red) and the expected value of gridded \gls{SGS} realizations (black). This discrepancy suggests additional high-grade continuity is required up to approximately 30m (six connected five-meter composites).

\begin{figure}[htb!]
    \centering
    \includegraphics[scale=0.75, max size={\textwidth}{\textheight}]{./0-Figures/06-Ch6/data_sgs_runs.png}
    \caption{Cumulative run length frequencies above the 0.9 quantile from the drillhole data and the base-case \gls{SGS} model.}
    \label{fig:data_sgs_runs}
\end{figure}

The decomposition of the target variogram structures into individual components forms the initial latent Gaussian pool. Each nested variogram structure defines the covariance of a latent factor with zero nugget and sill of 1.0. As the continuous variogram also reproduces the indicator variograms the initial pool consists of the two nested structures in Table \ref{tab:ns_expvar} for a total of $2 + 1 = 3$ (plus one for the nugget effect) factors. Additional structures are added to pool that correspond with high-grade features of the conceptual geological model and the overall orientation of drilling. As a pure nugget factor is added to the pool, any structure with a major range less than 30 meters is pruned to prevent adding too much noise to the network inputs. Though the network can filter this noise, experiments show that some level of pruning improves the final parameter inference. Table \ref{tab:pool} shows the covariance structure of each component in the final pool, excluding the nugget factor. Factors 3 and 4 correspond to high-grade structures.


% Additional structures that correspond to high-grade clusters are added to the pool. The grade distribution is thresholded at the $95^{th}$ quantile generating a binary indicator. Agglomerative clustering \citep{mullner2011modern} generates spatially coherent clusters using x, y, and z coordinates and the continuous variable. Cluster orientations and anisotropies are determined from the eigenvectors and eigenvalues of the 3x3 covariance matrix of cluster coordinates. The x, y, and z components of the eigenvectors form \gls{GSLIB} style rotation angles as:
% \begin{align}
%     \text{azm} & = 90 - \text{atan2}(y, x) * 180/\pi               \\
%     \text{dip} & = \text{atan2}(z, \sqrt{x^{2} + y^{2}}) * 180/\pi
%     \label{eq:azmdip}
% \end{align}

\begin{table}[!htb]
    \centering
    \caption{Covariance structures of the Gaussian pool (excluding the nugget).}
    \resizebox{0.9\width}{!}{\input{0-Tables/pool.tex}}
    \label{tab:pool}
\end{table}

The choice of activation function exponent, $\omega$, controls each factor's influence on either high or low values. $\omega < 1$ emphasizes low values (<0 in Gaussian units) and $\omega > 1$ emphasizes high values (>0 in Gaussian units). Table \ref{tab:omega} shows the minimum and maximum bound for each trainable $\omega$ parameter. Factors 1 and 2 are constrained to be relatively neutral, influencing high and low values but centred about $1.0$, while Factors 3 and 4 are constrained to influence high values only. The nugget effect factor is constrained to $\omega=1$.

\begin{table}[!htb]
    \centering
    \caption{$\omega$ bounds by factor.}
    \resizebox{0.9\width}{!}{\input{0-Tables/omega.tex}}
    \label{tab:omega}
\end{table}

The number of factors in the Gaussian pool dictates the network architecture. The pool consists of 4 structures, plus one for the nugget, for five latent Gaussian factors, resulting in an input layer of five nodes. Each input node has a single connection weight to a single hidden layer of the same dimension as the input. The network has $2 \cdot M = 10$ trainable parameters, five connection weights, and five $\omega$ values.

Table \ref{tab:de_params} shows \gls{DE} parameters. The indicator thresholds used for optimization correspond to the indicator variograms in Section \ref{sec:eda}, that is, $G^{-1}([0.1, 0.5, 0.9])$ where $G^{-1}$ is the inverse of the Gaussian \gls{CDF}. Runs and $n$-point connectivity consider a maximum of 10 steps ($\approx$50m).

\begin{table}[!htb]
    \centering
    \caption{Differential Evolution parameters.}
    \resizebox{0.9\width}{!}{\input{0-Tables/de_params.tex}}
    \label{tab:de_params}
\end{table}

Network optimization runs for 1500 iterations resulting in a reasonably stable objective function value. The objective function value (Figure \ref{fig:fobj}) does not reach zero as it is the expected value across all realizations. Though the objective function components are weighted, any deviation in the number of runs can lead to larger objective function values. Table \ref{tab:opt_omega} shows the final optimized connection weight and  $\omega$ parameters. Figure \ref{fig:nmropt_uncond_reals} shows plan-view, east-west and north-south sections thorough the first unconditional realization at the data locations generated by \texttt{NMROPT}. Objective components are calculated using these realizations.

% \begin{figure}[htb!]
%     \centering
%     \includegraphics[scale=0.75, max size={\textwidth}{\textheight}]{./0-Figures/06-Ch6/fobj.png}
%     \caption{\Gls{DE} objective value versus iteration.}
%     \label{fig:fobj}
% \end{figure}

% \begin{table}[!htb]
%     \centering
%     \caption{Optimal connection weight and $\omega$ parameters.}
%     \resizebox{0.9\width}{!}{\input{0-Tables/opt_omega.tex}}
%     \label{tab:opt_omega}
% \end{table}

\begin{figure}
    \centering
    \subfloat[\Gls{DE} objective value versus iteration.]{
        \includegraphics[width=0.4\linewidth]{./0-Figures/06-Ch6/fobj.png}
        \label{fig:fobj}
    }
    \subfloat[Optimal connection weight and $\omega$ parameters.]{
        \adjustbox{valign=c}{\input{0-Tables/opt_omega.tex}}
        \label{tab:opt_omega}
    }
    \caption{\Gls{DE} objective function value and final optimized network parameters.}
\end{figure}

% \foreach \sec/\name in \sectuples
% {
%     \begin{figure}[htb!]
%         \centering
%         \includegraphics[scale=0.5, max size={\textwidth}{\textheight}]{./0-Figures/06-Ch6/nmropt_uncond_real0_\sec.png}
%         \caption{ \name \ sections through first unconditional realization of Gaussian values generated by \texttt{NMROPT}. Objective components are calculated using these realizations. }
%         \label{fig:nmropt_uncond_real0_\sec}
%     \end{figure}
% }

\begin{figure}
    \centering
    \tabskip=0pt
    \valign{#\cr
        \hbox{%
            \begin{subfigure}[b]{.55\textwidth}
                \centering
                \includegraphics[width=\textwidth]{./0-Figures/06-Ch6/nmropt_uncond_real0_xy.png}
                \caption{}
            \end{subfigure}%
        }\cr
        \noalign{\hfill}
        \hbox{%
            \begin{subfigure}{.45\textwidth}
                \centering
                \includegraphics[width=\textwidth]{./0-Figures/06-Ch6/nmropt_uncond_real0_xz.png}
                \caption{}
            \end{subfigure}%
        }\vfill
        \hbox{%
            \begin{subfigure}{.45\textwidth}
                \centering
                \includegraphics[width=\textwidth]{./0-Figures/06-Ch6/nmropt_uncond_real0_yz.png}
                \caption{}
            \end{subfigure}%
        }\cr
    }
    \caption{Plan (a), east-west (b) and north-south (c) sections through the first unconditional realization of Gaussian values generated by \texttt{NMROPT}. Objective function components are evaluated using these realizations. }
    \label{fig:nmropt_uncond_reals}
\end{figure}

A critical component of the \texttt{NMROPT} workflow is checking the reproduction of the optimization targets. Deviations from these targets will likely manifest in the imputed conditioning data and final realizations. Figures \ref{fig:nmropt_repro_vario} to \ref{fig:nmropt_repro_runs} show variogram, indicator variogram and cumulative run-length frequency reproduction with the optimal \gls{NMR} parameters. Variogram and indicator variogram reproduction is reasonable though there is some deviation from the target model, particularly at shorter ranges in the principal directions. This deviation comes at the expense of increasing high-grade (0.9 quantile) continuity in the drilling direction (roughly parallel to the tertiary variogram direction). This increased continuity is evident in the 0.9 quantile run-length frequency plot (Figure \ref{fig:nmropt_repro_runs} right) where the unconditional \texttt{NMROPT} realizations show continuity greater than that in the data. Consequently, the 0.1 and 0.5 quantiles show slightly decreased continuity relative to the data (Figure \ref{fig:nmropt_repro_runs} left and center). This increased continuity is advantageous as results show that the effect of conditioning in the final realizations can reduce extreme value continuity.

\begin{figure}[htb!]
    \centering
    \includegraphics[scale=0.60, max size={\textwidth}{\textheight}]{./0-Figures/06-Ch6/repro_vario.png}
    \caption{\texttt{NMROPT} continuous variogram reproduction for \csnreals \ realizations. The black line is the variogram model, the red line is the average variogram and the shaded red area encloses the minimum and maximum variogram values. Left to right are the major, minor and vertical directions, respectively.}
    \label{fig:nmropt_repro_vario}
\end{figure}

\begin{figure}
    \begin{subfigure}{1.0\textwidth}
        \centering
        \includegraphics[scale=0.60, max size={\textwidth}{\textheight}]{./0-Figures/06-Ch6/repro_ivario_0_1.png}
        \caption{0.1 Quantile}
    \end{subfigure}
    \begin{subfigure}{1.0\textwidth}
        \centering
        \includegraphics[scale=0.60, max size={\textwidth}{\textheight}]{./0-Figures/06-Ch6/repro_ivario_0_5.png}
        \caption{0.5 Quantile}
    \end{subfigure}
    \begin{subfigure}{1.0\textwidth}
        \centering
        \includegraphics[scale=0.60, max size={\textwidth}{\textheight}]{./0-Figures/06-Ch6/repro_ivario_0_9.png}
        \caption{0.9 Quantile}
    \end{subfigure}
    \caption{\texttt{NMROPT} indicator variogram reproduction for \csnreals \ realizations for the 0.1 (a), 0.5 (b) and 0.9 (c) quantiles. Left to right are the major, minor and vertical directions, respectively. The black line is the variogram model, the red line is the average variogram and the shaded red area encloses the minimum and maximum variogram values.}
    \label{fig:nmropt_repro_ivario}
\end{figure}

\begin{figure}[htb!]
    \centering
    \includegraphics[scale=0.60, max size={\textwidth}{\textheight}]{./0-Figures/06-Ch6/repro_runs.png}
    \caption{\texttt{NMROPT} cumulative run-length frequency reproduction for \csnreals \ realizations. Thresholds 1, 2, and 3 correspond to the 0.1, 0.5 and 0.9 quantiles. The black line is the target run-length frequency model, the red line is the average experimental value and the shaded red area encloses the minimum and maximum experimental values.}
    \label{fig:nmropt_repro_runs}
\end{figure}


\FloatBarrier
\section{Latent Factor Imputation}
\label{sec:fact_imp}

The optimized \gls{NMR} parameters from Section \ref{sec:param} are the basis for latent factor imputation. The optimized mapping function and Gaussian pool are input to the program \texttt{NMRIMP}, simulating latent factor realizations via \gls{SGRI}. \csnreals \ realizations are imputed for each factor specified in the Gaussian pool, plus the nugget effect. All imputed realizations are checked to ensure they (1) reproduce the data within the specified polishing tolerance (Table \ref{tab:imp_pars}); (2) imputed realizations are on average univariate Gaussian; (3) imputed factors are on average uncorrelated, and (4) each imputed factor on average reproduces its single structure variogram model.

\begin{table}[!htb]
    \centering
    \caption{\texttt{NMRIMP} parameters.}
    \resizebox{0.9\width}{!}{\input{0-Tables/imp_pars.tex}}
    \label{tab:imp_pars}
\end{table}

Figure \ref{fig:imputed_scatters} shows a scatter plot matrix of the original data values, plus the first realization of the mapped imputed values and all latent factors. The top row of the matrix is somewhat redundant, however it shows the perfect correlation between the observed data and mapped imputed values. The marginal histograms show that each latent distribution is standard normal, with reasonable statistical fluctuation. The scatter plots between each latent factor show roughly concentric bivariate Gaussian density contours and $|\rho| < 0.10$. The average correlation coefficient across all realizations is within this tolerance suggesting the latent factors are effectively uncorrelated. Figure \ref{fig:nmrimp_repro_gvario} shows variogram reproduction for each imputed factor. There is some deviation from the specified target models though overall, variogram reproduction is reasonable. This deviation is largely present for factors 3 and 4 where the range in the major direction is long relative to the domain size in that orientation.

\begin{figure}[htb!]
    \centering
    \includegraphics[scale=0.75, max size={\textwidth}{\textheight}]{./0-Figures/06-Ch6/imputed_scatters.png}
    \caption{Scatter plot matrix illustrating the relationships between the observed data values, mapped imputed values and latent factors in Gaussian units. The histograms show the marginal distributions of each variable, by row. }
    \label{fig:imputed_scatters}
\end{figure}

\begin{figure}
    \begin{subfigure}{1.0\textwidth}
        \centering
        \includegraphics[scale=0.60, max size={\textwidth}{\textheight}]{./0-Figures/06-Ch6/expvario_fact1.png}
        \caption{Factor 1}
    \end{subfigure}
    \begin{subfigure}{1.0\textwidth}
        \centering
        \includegraphics[scale=0.60, max size={\textwidth}{\textheight}]{./0-Figures/06-Ch6/expvario_fact2.png}
        \caption{Factor 2}
    \end{subfigure}
    \begin{subfigure}{1.0\textwidth}
        \centering
        \includegraphics[scale=0.60, max size={\textwidth}{\textheight}]{./0-Figures/06-Ch6/expvario_fact3.png}
        \caption{Factor 3}
    \end{subfigure}
    \begin{subfigure}{1.0\textwidth}
        \centering
        \includegraphics[scale=0.60, max size={\textwidth}{\textheight}]{./0-Figures/06-Ch6/expvario_fact4.png}
        \caption{Factor 4}
    \end{subfigure}
    \caption{Variogram reproduction for \csnreals \ imputed realizations of each factor. The black line is the variogram model, the red line is the average variogram and the shaded red area encloses the minimum and maximum variogram values. Table \ref{tab:pool} specifies the Gaussian pool.}
    \label{fig:nmrimp_repro_gvario}
\end{figure}


\FloatBarrier
\section{Latent Factor Simulation}
\label{sec:fact_sim}

Imputed factor realizations from Section \ref{sec:fact_imp} become conditioning data for gridded factor realizations. Each univariate Gaussian factor realization conditions a gridded realization in a one-for-one fashion. That is, each simulated realization uses a unique data realization. Gridded realizations in this case study are simulated using \gls{SGS} though any conditional simulation algorithm is valid.

The point scale simulation grid utilizes a cell size of 2.5 x 2.5 x 5m for 2,236,948 nodes; Table \ref{tab:simgrid} summarizes its parameters. \csnreals \ realizations of each factor are simulated and checked similarly to any other Gaussian simulation workflow. The realizations are, on average, univariate Gaussian and reproduce the variogram. Figure \ref{fig:gridded_factors} shows a plan-view section through the first realization of the gridded factors.

\begin{table}[!htb]
    \centering
    \caption{Simulation grid parameters.}
    \resizebox{0.9\width}{!}{\input{0-Tables/simgrid.tex}}
    \label{tab:simgrid}
\end{table}

\begin{figure}[htb!]
    \centering
    \includegraphics[scale=0.5, max size={\textwidth}{\textheight}]{./0-Figures/06-Ch6/gridded_factors_real1_xy.png}
    \caption{Plan-view section through the first realization of the gridded factors, excluding the nugget.}
    \label{fig:gridded_factors}
\end{figure}

Once factors are defined at all grid nodes, they are mapped from latent to observed space by applying the optimized \gls{NMR}. Mapping consists of interpolating the raw activation values (\gls{NMR} output) with the normal score reference distribution generated by \texttt{NMRIMP}. Using a single reference distribution ensures consistency between imputation and gridded simulation. The \gls{NMR} realizations are checked to ensure they reproduce the continuous variogram model, indicator variogram models and cumulative run-length frequencies and are, on average, univariate Gaussian. Figure \ref{fig:ns_reals} shows plan-view, east-west and north-south sections through the first \gls{NMR} realization mapped to Gaussian units. Figure \ref{fig:repro_gridded_cdfs} shows \gls{CDF} reproduction of the \gls{NMR} realizations in Gaussian units (left panel). The realizations show reasonable variance given the level of conditioning and are, on average, univariate Gaussian. Figure \ref{fig:orig_reals} shows plan-view, east-west and north-south sections through the first \gls{NMR} realization back-transformed to original units. These figures show the vertical and downhole high-grade continuity imparted by factors 3 and 4 (Table \ref{tab:pool}). The overall background continuity dipping to the east imparted by the continuous variogram model is clear in the east-west sections (Figure \ref{fig:orig_reals} (b)). Figure \ref{fig:repro_gridded_cdfs} shows \gls{CDF} reproduction of the \gls{NMR} realizations in back-transformed to original units (right panel). The realizations reproduce the declustered histogram of the training data well.

% \foreach \sec/\name in \sectuples
% {
%     \begin{figure}[htb!]
%         \centering
%         \includegraphics[scale=0.5, max size={\textwidth}{\textheight}]{./0-Figures/06-Ch6/ns_reals_\sec.png}
%         \caption{ \name \ sections through the first \gls{NMR} realization mapped to Gaussian units. }
%         \label{fig:ns_reals_\sec}
%     \end{figure}
% }

\begin{figure}
    \centering
    \tabskip=0pt
    \valign{#\cr
        \hbox{%
            \begin{subfigure}[b]{.55\textwidth}
                \centering
                \includegraphics[width=\textwidth]{./0-Figures/06-Ch6/ns_reals_xy.png}
                \caption{}
            \end{subfigure}%
        }\cr
        \noalign{\hfill}
        \hbox{%
            \begin{subfigure}{.45\textwidth}
                \centering
                \includegraphics[width=\textwidth]{./0-Figures/06-Ch6/ns_reals_xz.png}
                \caption{}
            \end{subfigure}%
        }\vfill
        \hbox{%
            \begin{subfigure}{.45\textwidth}
                \centering
                \includegraphics[width=\textwidth]{./0-Figures/06-Ch6/ns_reals_yz.png}
                \caption{}
            \end{subfigure}%
        }\cr
    }
    \caption{Plan (a), east-west (b) and north-south (c) sections through the first \gls{NMR} realization mapped to Gaussian units.}
    \label{fig:ns_reals}
\end{figure}

\begin{figure}
    \begin{subfigure}{0.5\textwidth}
        \centering
        \includegraphics[scale=0.6, max size={\textwidth}{\textheight}]{./0-Figures/06-Ch6/repro_gridded_ns_cdf.png}
    \end{subfigure}
    \begin{subfigure}{0.5\textwidth}
        \centering
        \includegraphics[scale=0.6, max size={\textwidth}{\textheight}]{./0-Figures/06-Ch6/repro_gridded_cdf.png}
    \end{subfigure}
    \caption{\gls{CDF} reproduction for \csnreals \ \gls{NMR} realizations mapped to Gaussian units (left) and original units (right).}
    \label{fig:repro_gridded_cdfs}
\end{figure}

% \foreach \sec/\name in \sectuples
% {
%     \begin{figure}[htb!]
%         \centering
%         \includegraphics[scale=0.5, max size={\textwidth}{\textheight}]{./0-Figures/06-Ch6/orig_real0_\sec.png}
%         \caption{ \name \ sections through the first \gls{NMR} realization back-transformed to original units. }
%         \label{fig:orig_reals_\sec}
%     \end{figure}
% }

\begin{figure}
    \centering
    \tabskip=0pt
    \valign{#\cr
        \hbox{%
            \begin{subfigure}[b]{.55\textwidth}
                \centering
                \includegraphics[width=\textwidth]{./0-Figures/06-Ch6/orig_real0_xy.png}
                \caption{}
            \end{subfigure}%
        }\cr
        \noalign{\hfill}
        \hbox{%
            \begin{subfigure}{.45\textwidth}
                \centering
                \includegraphics[width=\textwidth]{./0-Figures/06-Ch6/orig_real0_xz.png}
                \caption{}
            \end{subfigure}%
        }\vfill
        \hbox{%
            \begin{subfigure}{.45\textwidth}
                \centering
                \includegraphics[width=\textwidth]{./0-Figures/06-Ch6/orig_real0_yz.png}
                \caption{}
            \end{subfigure}%
        }\cr
    }
    \caption{Plan (a), east-west (b) and north-south (c) sections through the first \gls{NMR} realization back-transformed to original units.}
    \label{fig:orig_reals}
\end{figure}


Figure \ref{fig:repro_gridded_vario} shows gridded continuous variogram reproduction for the \gls{NMR} realizations in Gaussian units. The experimental variogram of the first imputed data realization and the average of \gls{SGS} realizations are shown for reference. There is reasonable agreement between the target model (blue), the imputed data and the gridded realization average. There is some deviation; however, these are the same deviations present from the inference of the network parameters (Figure \ref{fig:nmropt_repro_vario}). Indicator variogram reproduction in Figure \ref{fig:repro_gridded_ivario} shows similar deviations observed in the optimization process though the gridded variograms reproduce the target model and imputed data reasonably well. Figure \ref{fig:repro_gridded_runs} shows gridded cumulative run-length frequency reproduction for both the \gls{NMR} and \gls{SGS} realizations, respectively. The expected value of the \gls{SGS} realizations is shown in black. As expected the \gls{NMR} realizations show increased continuity over \gls{SGS}. \gls{SGS} shows greater continuity at shorter run-lengths; however, beyond a run-length of three composites, the \gls{NMR} model is more continuous.


\begin{figure}[htb!]
    \centering
    \includegraphics[scale=0.60, max size={\textwidth}{\textheight}]{./0-Figures/06-Ch6/repro_gridded_vario.png}
    \caption{\gls{NMR} continuous variogram reproduction for \csnreals \ realizations. Left to right are the major, minor and vertical directions, respectively.}
    \label{fig:repro_gridded_vario}
\end{figure}

\begin{figure}
    \begin{subfigure}{1.0\textwidth}
        \centering
        \includegraphics[scale=0.60, max size={\textwidth}{\textheight}]{./0-Figures/06-Ch6/repro_gridded_ivario_0_1.png}
        \caption{0.1 Quantile}
    \end{subfigure}
    \begin{subfigure}{1.0\textwidth}
        \centering
        \includegraphics[scale=0.60, max size={\textwidth}{\textheight}]{./0-Figures/06-Ch6/repro_gridded_ivario_0_5.png}
        \caption{0.5 Quantile}
    \end{subfigure}
    \begin{subfigure}{1.0\textwidth}
        \centering
        \includegraphics[scale=0.60, max size={\textwidth}{\textheight}]{./0-Figures/06-Ch6/repro_gridded_ivario_0_9.png}
        \caption{0.9 Quantile}
    \end{subfigure}
    \caption{\gls{NMR} indicator variogram reproduction for \csnreals \ realizations for the 0.1 (a), 0.5 (b) and 0.9 (c) quantiles. Left to right are the major, minor and vertical directions, respectively.}
    \label{fig:repro_gridded_ivario}
\end{figure}

\begin{figure}[htb!]
    \centering
    \includegraphics[scale=0.75, max size={\textwidth}{\textheight}]{./0-Figures/06-Ch6/repro_gridded_runs.png}
    \caption{\gls{NMR} 0.9 quantile cumulative run-length frequency reproduction for \csnreals \ realizations. 0.9 quantile from \gls{SGS} is shown for reference.}
    \label{fig:repro_gridded_runs}
\end{figure}


\FloatBarrier
\section{Post Processing}
\label{sec:post}

Point scale realizations are block-averaged to the \gls{SMU} volume for comparison at a relevant scale. The \gls{SMU} scale grid is centred on the southwest corner of the point scale grid, encompassing most of the test data set. Table \ref{tab:smugrid} shows the parameters of the \gls{SMU} grid. As a goal of the \gls{NMR} is to improve local high-grade resources conditional to certain events, a simplified stope optimization process is implemented to mimic the selection of local high-grade resources at the \gls{SMU} scale. The reference \gls{OK} model from Section \ref{sec:eda} is used for stope optimization. Stopes with a fixed footprint of 30 x 30 m and a minimum height of 40 m are selected considering the \gls{OK} reference model and a \gls{COG} of 2.0 units. An initial grid of stope footprint centroids is generated across the reference model. All valid footprints about the centroid are evaluated and the highest grade, minimum volume stope is selected. The initial stope's z-dimension is then expanded one grid level at a time until the volume is no longer above \gls{COG} or a maximum height of 80 m is reached. This process is simplified and intended to be a straightforward proxy for mining selectivity. The resulting volumes are not true optimums. Figure \ref{fig:stopes_testdata_xy} shows a plan view section through the reference \gls{OK} model showing the stope shapes and the test data locations.


\begin{table}[!htb]
    \centering
    \caption{\Gls{SMU} grid parameters.}
    \resizebox{0.9\width}{!}{\input{0-Tables/smugrid.tex}}
    \label{tab:smugrid}
\end{table}

\begin{figure}[htb!]
    \centering
    \includegraphics[scale=0.60, max size={\textwidth}{\textheight}]{./0-Figures/06-Ch6/stopes_testdata_xy.png}
    \caption{Plan view section through the reference \gls{OK} model showing stope shapes and the test dataset. }
    \label{fig:stopes_testdata_xy}
\end{figure}

Stopes containing composites from the test dataset are used to evaluate the performance of the \gls{NMR} realizations relative to \gls{SGS} in local, high-grade regions of the model. The test composites are coded by stope ID and compared directly to simulated realizations within the same volume. The following section summarizes model performance.

\FloatBarrier
\section{Model Comparison}
\label{sec:compare}

The following section compares the \gls{NMR} and \gls{SGS} realizations conditional to high-grade stope volumes. Figure \ref{fig:nmr_sgs_gtcurve_all_stopes} shows \gls{GT} curves for all stope volumes for the \gls{NMR} (left) and \gls{SGS} (right) \gls{SMU} scale realizations. Test data tonnes and grades come from length-weighted composites in the test set flagged within the stope volumes. This test shows how well each set of realizations reproduces data the model has not seen. Across all stopes, the \gls{SGS} model is higher in grade and tonnage than the composites. \gls{NMR} realizations are overall lower in grade and tonnage relative to the \gls{SGS} realizations and more closely reproduce the test data. This good reproduction is due to the anisotropies of the high-grade factors constraining high-grade features in particular directions instead of being controlled by a continuous variogram (that considers the full range of grade values) in the \gls{SGS} context.

\begin{figure}[htb!]
    \centering
    \includegraphics[scale=0.6, max size={\textwidth}{\textheight}]{./0-Figures/06-Ch6/nmr_sgs_gtcurve_all_stopes.png}
    \caption{\Gls{GT} curves for all stope volumes for the \gls{NMR} (left) and \gls{SGS} (right) models. }
    \label{fig:nmr_sgs_gtcurve_all_stopes}
\end{figure}

Table \ref{tab:nmr_sgs_stope_delta} shows more detailed grade and deviation data on a stope-by-stope basis. The table shows the number of test data in each stope, the mean grade of the composites, and the percent deviation from the test data mean for the \gls{OK}, \gls{SGS} and \gls{NMR} expected values. Values are sorted in
ascending order by \gls{NMR} expected value. In some situations, all models perform poorly, both over- and under-estimating the test data mean. These large deviations occur in stopes where the training and testing data are unbalanced. That is, there is a significant deviation between the mean of the conditioning data and the mean of the hold-out data. Figure \ref{fig:test_train_deviation} shows the percent deviation from the test data mean for the training data and \gls{NMR} and \gls{SGS} expected values within each stope. Subsequent comparisons consider stopes where this deviation is less than 20\%. Where the training and testing data are balanced concerning grade, the \gls{NMR} model performs well relative to \gls{SGS}, particularly stopes 45, 653, 38 and 885. The \gls{NMR} shows deviations less than 3.5\% from the test data for these stopes while the \gls{SGS} model shows deviations from 5-11\%. It should be noted that there are stopes where \gls{SGS} outperforms the \gls{NMR} (particularly when the mean of the test data increases above \gls{COG}).

\begin{figure}[htb!]
    \centering
    \includegraphics[scale=0.6, max size={\textwidth}{\textheight}]{./0-Figures/06-Ch6/test_train_deviation.png}
    \caption{Percent deviation from the test data set by stope ID. Stopes where train/test deviation is less than 20\% are retained for comparison. }
    \label{fig:test_train_deviation}
\end{figure}

\begin{table}[!htb]
    \centering
    \caption{\% difference in expected value between test data, \gls{OK} mean, \gls{SGS} expected value and \gls{NMR} expected value by stope (>2.0 unit \gls{COG}). Stopes with greater than 20 test data and test set deviation is less than 20\% are shown. Values are sorted in ascending order by \gls{NMR} expected value.}
    \resizebox{0.9\width}{!}{\input{0-Tables/nmr_sgs_stope_delta.tex}}
    \label{tab:nmr_sgs_stope_delta}
\end{table}

\begin{figure}[htb!]
    \centering
    \includegraphics[scale=0.6, max size={\textwidth}{\textheight}]{./0-Figures/06-Ch6/stope_mean_grades.png}
    \caption{Mean grades by stope ID where test set deviation is less than 20\%. }
    \label{fig:stope_mean_grades}
\end{figure}

Figure \ref{fig:nmr_sgs_gtcurve_stope38} shows the \gls{NMR} vs \gls{SGS} \gls{GT} curve for stope 38. These \gls{GT} curves show similar characteristics to Figure \ref{fig:nmr_sgs_gtcurve_all_stopes} where the \gls{SGS} model is higher grade through virtually all cutoff grades. The \gls{NMR} model shows better reproduction of the test composites grades (below 2.5 units) and the fraction of total tonnes above \gls{COG}. Figure \ref{fig:stope38_test_data} shows east-west sections though the spatial centroid of stope 38 showing the reference \gls{OK} model, and the first realization of the \gls{SGS} and \gls{NMR} models with the test data. Visually, the \gls{NMR} realization does a good job of reproducing the test data, and vertical high-grade continuity imparted by factor 3 is apparent. Figure \ref{fig:stope246_test_data} shows sections through the volume of stope 246 where the \gls{NMR} model performs poorly. Again, factor 3 imparts strong vertical continuity that is clearly visible. This strong continuity constrains the high-grade mineralization resulting in underestimation of the true grades given the deterministic stope placement.

% good stope
\begin{figure}[htb!]
    \centering
    \includegraphics[scale=0.6, max size={\textwidth}{\textheight}]{./0-Figures/06-Ch6/nmr_sgs_gtcurve_stope39.png}
    \caption{\Gls{GT} curves for stope 39 for \gls{NMR} (left) and \gls{SGS} (right) models. }
    \label{fig:nmr_sgs_gtcurve_stope39}
\end{figure}

\begin{figure}[htb!]
    \centering
    \includegraphics[scale=0.6, max size={\textwidth}{\textheight}]{./0-Figures/06-Ch6/stope39_test_data.png}
    \caption{Sections through stope 39 showing the test data, \gls{OK} model, and the first block averaged realization of the \gls{SGS} and \gls{NMR} models.}
    \label{fig:stope39_test_data}
\end{figure}

% bad stope
\begin{figure}[htb!]
    \centering
    \includegraphics[scale=0.6, max size={\textwidth}{\textheight}]{./0-Figures/06-Ch6/nmr_sgs_gtcurve_stope47.png}
    \caption{\Gls{GT} curves for stope 47 for \gls{NMR} (left) and \gls{SGS} (right) models. }
    \label{fig:nmr_sgs_gtcurve_stope47}
\end{figure}

\begin{figure}[htb!]
    \centering
    \includegraphics[scale=0.6, max size={\textwidth}{\textheight}]{./0-Figures/06-Ch6/stope47_test_data.png}
    \caption{Sections through stope 47 showing the test data, \gls{OK} model, and the first block averaged realization of the \gls{SGS} and \gls{NMR} models.}
    \label{fig:stope47_test_data}
\end{figure}

Throughout all cutoff grades the \gls{NMR} realizations are lower grade than the \gls{SGS} realizations. This leads to better reproduction of the test data across all stope volumes, however discrepancies exists stope-by-stope. The \gls{NMR} outperforms \gls{SGS} when \gls{SGS} overestimates the true grade. If \gls{SGS} underestimates the true grade, typically the \gls{NMR} further underestimates, though not always (stopes 38, 885, 53). This phenomenon is likely due to strongly anisotropic latent factors imparting high-grade continuity (factors 3 and 4) that forms a ``hard'' boundary with background mineralization. This feature is evident in the bottom panel of Figure \ref{fig:stope47_test_data} where sharp boundaries are present between vertical high-grade structures (>3.0 units) and lower-grade background mineralization. Stope placement considering a smooth deterministic model may not be able to capture these features in probabilistic realizations.

\FloatBarrier
\section{Discussion}
\label{sec:discuss06}

The \gls{NMR} can reproduce high-grade continuity features that cannot be captured with a continuous variogram alone. The specification of $\omega$ bounds allows the practitioner to impart specific spatial features onto specific portions of the continuous grade range. The resulting \gls{NMR} realizations are univariate Gaussian, however they capture non-Gaussian connectivity features. In this case study, the connectivity of extreme values is particularly important. A base-case \gls{SGS} model shows that realizations generated under a multivariate-Gaussian assumption cannot alone capture the high-grade continuity observed in the drillholes. The \gls{NMR} parameter inference workflow determines the optimal weight to each factor and the exponent $\omega$ for the network activation function. Parameters are optimized to reproduce continuous, and indicator variograms and cumulative run-length frequencies observed in the drillhole data in the final gridded realizations. The indicator variograms do not show significant asymmetry in this case study, though the \gls{NMR} can reproduce these non-Gaussian features. In addition, high-grade continuity, above what is observed in the drillholes, is embedded in the \gls{NMR} through highly anisotropic factors where $\omega \ge 1$. This increased continuity seems required when the conditional simulation of the Gaussian factors leads to the destructuring of extreme values after passing through the \gls{NMR}.

Across all stope volumes, the \gls{NMR} realizations more accurately reproduce the grade and tonnage of the test dataset than the \gls{SGS} realizations. On a stope-by-stope basis, the performance of the \gls{NMR} model is variable, though major deviations in grade between the train and test composites within any given stope should be considered. Stopes with many test data, such as stope 45, the \gls{NMR} expected values show a 10\% improvement over the \gls{SGS} expected value. Comparison of composite averages to stope volume expected values is assumed to be an adequate proxy to production reconciliation data; this ``test'' dataset scenario is likely as close as we can get without having true as-mined shapes and production grade information. It is also important to note that the stope optimization workflow is not generating a true optimal shape. The stope shapes are a geotechnically feasible, heuristic proxy to mimic the mining selectivity.


