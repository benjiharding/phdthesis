%!TEX root = ../Thesis_example_compile_this.tex

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\chapter{Case Study}
\label{ch:06casestudy}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

This chapter presents an application of the complete \gls{NMR} workflow to a real \gls{3D} dataset. The \gls{NMR} workflow is designed to capture the spatial features of non‚ÄêGaussian distributions in a way that the multi-Gaussian assumption and a \gls{LMR} cannot. The case study aims to construct an \gls{NMR} spatial model and compare it to a traditional \gls{SGS} model. The dataset comes from a mineral deposit where the project operator observes non-Gaussian characteristics within drillholes that are not well reproduced by \gls{SGS}. Within local stope volumes \gls{SGS} cannot reproduce the connectivity of high-grades present in drillhole data.

The workflow consists of (1) inferring the parameters, $\theta$, of the latent-observed mapping function, $\mathcal{F}_{\theta}$, with \texttt{NMROPT}, (2) imputing the latent factors at the data locations with \texttt{NMRIMP} that return the actual values when mapped and (3) conditional simulation of the imputed factors on the grid. The learned mapping is non-linear. The idea is that the \gls{NMR} realizations can capture non-Gaussian spatial features such as asymmetric indicator variograms and connectivity of extreme values. Twenty-five conditional realizations are generated with the \gls{NMR}, and pertinent model statistics are checked and compared to \gls{SGS}. Defining characteristics of the deposit and mineralization type are omitted for confidentiality purposes.

\FloatBarrier
\section{Exploratory Data Analysis}
\label{sec:06eda}

The complete dataset consists of $27,983$ values nominally composited to 5 meters. All coordinates are transformed such that the spatial centroid of the data is $(x=y=z=0)$. For cross-validation purposes, approximately 30\% of the data is withheld as a ``test set'', and the remaining 70 \% is the ``training set''. Figure \ref{fig:train_data} shows plan-view, east-west and north-south sections through the training dataset coloured by the variable of interest. The test data is not exposed to any subsequent modeling step. Figure \ref{fig:datasets} shows \glspl{CDF} and basic summary statistics for the training and test datasets. There is a notable imbalance between the training and testing sets, with the latter being $14\%$ higher grade. The testing set is not a random data partition but rather a collection of data drilled after a certain date. This choice is a reasonable approach to partitioning as it ensures complete drillholes in both datasets, preventing optimistic metrics with leave-one-sample-out style cross-validation. The downside of this approach is that the holes drilled after the cutoff are for stope definition purposes, leading to a higher mean grade. This imbalance must be considered when assessing the reproduction of the test set. All modeling considers the training set only, and Section \ref{sec:06compare} considers the test set.

\begin{figure}[htb!]
    \centering
    \includegraphics[scale=0.5, max size={\textwidth}{\textheight}]{./0-Figures/06-Ch6/test_train_cdf.png}
    \caption{ \Glspl{CDF} for training (grey) and testing (red) datasets. }
    \label{fig:datasets}
\end{figure}

Experimental variograms are first calculated using an omni-directional search that informs the nugget effect. This search uses short lags to highlight the shape and range of the short-scale continuity. The omni-directional variogram suggests a nugget effect of near zero, and that an exponential variogram shape is appropriate for the modeled variable. Directional experimental variograms are calculated first in original units and fitted with an exponential model. Figure \ref{fig:orig_expvar} shows the fitted experimental points, and Table \ref{tab:orig_expvar} shows the model parameters. The original unit variogram defines the search orientation and anisotropy for estimator-based declustering. Indicator variograms are calculated for the grade distribution's 0.1, 0.5 and 0.9 quantiles. Figures \ref{fig:ind_expvar} show the fitted indicator variogram models, and Table \ref{tab:ind_expvar} summarizes the model parameters. Interestingly, the 0.1 and 0.9 indicator variograms are not highly asymmetric with this dataset.

% \begin{table}[!htb]
%     \centering
%     \caption{Training and testing datasets.}
%     \resizebox{1\width}{!}{\input{0-Tables/variables.tex}}
%     \label{tab:datasets}
% \end{table}


% \foreach \sec/\name in \sectuples
% {
%     \begin{figure}[htb!]
%         \centering
%         \includegraphics[scale=0.5, max size={\textwidth}{\textheight}]{./0-Figures/06-Ch6/var_a_\sec.png}
%         \caption{ \name \ sections through the training dataset. }
%         \label{fig:train_\sec}
%     \end{figure}
% }

\begin{figure}
    \centering
    \tabskip=0pt
    \valign{#\cr
        \hbox{%
            \begin{subfigure}[b]{.50\textwidth}
                \centering
                \includegraphics[width=\textwidth]{./0-Figures/06-Ch6/var_a_xy.png}
                \caption{}
            \end{subfigure}%
        }\cr
        \noalign{\hfill}
        \hbox{%
            \begin{subfigure}{.50\textwidth}
                \centering
                \includegraphics[width=\textwidth]{./0-Figures/06-Ch6/var_a_xz.png}
                \caption{}
            \end{subfigure}%
        }\vfill
        \hbox{%
            \begin{subfigure}{.50\textwidth}
                \centering
                \includegraphics[width=\textwidth]{./0-Figures/06-Ch6/var_a_yz.png}
                \caption{}
            \end{subfigure}%
        }\cr
    }
    \caption{Plan (a), east-west (b) and north-south (c) sections through the training dataset.}
    \label{fig:train_data}
\end{figure}

\begin{figure}[htb!]
    \centering
    \includegraphics[scale=0.6, max size={\textwidth}{\textheight}]{./0-Figures/06-Ch6/var_a_variogram.png}
    \caption{Fitted original unit variograms in the major, minor and tertiary directions (left to right). }
    \label{fig:orig_expvar}
\end{figure}

\begin{table}[!htb]
    \centering
    \caption{Original unit variogram model parameters.}
    \resizebox{1\width}{!}{\input{0-Tables/var_a_variogram.tex}}
    \label{tab:orig_expvar}
\end{table}

\begin{figure}
    \begin{subfigure}{1.0\textwidth}
        \centering
        \includegraphics[scale=0.6, max size={\textwidth}{\textheight}]{./0-Figures/06-Ch6/var_a_ivariogram_0_1.png}
        \caption{0.1 Quantile}
    \end{subfigure}
    \begin{subfigure}{1.0\textwidth}
        \centering
        \includegraphics[scale=0.6, max size={\textwidth}{\textheight}]{./0-Figures/06-Ch6/var_a_ivariogram_0_5.png}
        \caption{0.5 Quantile}
    \end{subfigure}
    \begin{subfigure}{1.0\textwidth}
        \centering
        \includegraphics[scale=0.6, max size={\textwidth}{\textheight}]{./0-Figures/06-Ch6/var_a_ivariogram_0_9.png}
        \caption{0.9 Quantile}
    \end{subfigure}
    \caption{Fitted experimental indicator variograms for the 0.1 (a), 0.5 (b) and 0.9 (c) quantiles in the major, minor and tertiary directions (left to right).}
    \label{fig:ind_expvar}
\end{figure}

\begin{table}[!htb]
    \centering
    \caption{Indicator variogram model parameters. All models have zero nugget.}
    \resizebox{0.9\width}{!}{\input{0-Tables/ivario_models.tex}}
    \label{tab:ind_expvar}
\end{table}

Transformation to Gaussian space requires a representative \gls{CDF}.  \Gls{ID2} estimation produces declustering weights. A grid of 5 x 5 x 5 meter blocks is used considering a 25-meter buffer in the x, y, and z directions around all available data (the \gls{SMU} grid). \Gls{ID2} estimation weights for each data are accumulated during an estimation run and used as declustering weights. The idea is that data in dense regions receive less total weight as many data are present in the search neighbourhood. In sparse areas, data receive more weight as fewer data are in the search neighbourhood. Estimator declustering is more robust than traditional cell declustering for irregular data configurations, as the search ellipse can capture the principal orientation of continuity. The limits of the estimation grid must be well-defined to prevent unintended edge effects \citep{Wilde2007}. Figure \ref{fig:declus_cdf} shows the clustered (black) and declustered \gls{CDF} (red).

After the normal score transformation, the experimental variogram of the normal scores is calculated and fitted with a model. Figure \ref{fig:ns_expvar} shows the fitted experimental points, and Table \ref{tab:ns_expvar} shows the model parameters. A normal score variogram permits the calculation of accuracy metrics, particularly the fraction of true values that fall within specified probability intervals. Figure \ref{fig:ns_xval} shows a leave-one-drillhole out cross-validation and accuracy plot for the fitted normal score variogram model. The scatter plot shows a reasonable \gls{SOR} and reproduction of the true mean. The accuracy plot suggests that the variogram model characterizes a reasonable uncertainty distribution.

\begin{figure}[htb!]
    \centering
    \includegraphics[scale=0.5, max size={\textwidth}{\textheight}]{./0-Figures/06-Ch6/var_a_declus_cdf.png}
    \caption{ Declustered \gls{CDF} (red) considering \gls{ID2} weights. }
    \label{fig:declus_cdf}
\end{figure}

\begin{figure}[htb!]
    \centering
    \includegraphics[scale=0.6, max size={\textwidth}{\textheight}]{./0-Figures/06-Ch6/ns_var_a_variogram.png}
    \caption{Fitted normal score variograms in the major, minor and tertiary directions (left to right). }
    \label{fig:ns_expvar}
\end{figure}

\begin{table}[!htb]
    \centering
    \caption{Normal score variogram model parameters.}
    \resizebox{1\width}{!}{\input{0-Tables/ns_var_a_variogram.tex}}
    \label{tab:ns_expvar}
\end{table}

\begin{figure}[htb!]
    \centering
    \includegraphics[scale=0.75, max size={\textwidth}{\textheight}]{./0-Figures/06-Ch6/nsvario_xval.png}
    \caption{Normal score variogram \gls{LOOCV} (left) and accuracy plot (right).}
    \label{fig:ns_xval}
\end{figure}

The final step of \gls{EDA} is to generate a reference model for validation purposes. An exhaustive model is generated with \gls{OK} considering a minimum of 6 and a maximum of 40 composites using a search ellipse with ranges and angles aligned with the fitted original units variogram model (Table \ref{tab:orig_expvar}).

\FloatBarrier
\section{Network Parameter Inference}
\label{sec:06param}

Parameterization of the \gls{NMR} requires the definition of (1) optimization targets, (2) a pool of latent Gaussian factors, (3) network architecture and (4) optimization hyperparameters. The continuous normal score and indicator variograms from Section \ref{sec:06eda} are optimization targets for parameterizing the \gls{NMR}. Target run distributions are calculated internally from the drillhole data by \texttt{NMROPT}. The $n$-point connectivity function is not considered, as the case study focuses on indicators above a high-grade threshold. When considering indicators above a threshold, cumulative run-length frequencies and the $n$-point connectivity function are analogous, and one can be calculated from the other. Thus, considering both in the objective function is redundant and would increase computation time.

The initial step in defining the Gaussian pool is checking how well a traditional simulation algorithm (e.g.\ \gls{SGS}) reproduces the optimization target only considering the normal score variogram. This ``base-case'' model provides insight into the required features to achieve the desired targets. \Gls{SGS} performs well reproducing the normal score and all indicator variograms, likely due to the data density of the training dataset. Though variograms are well reproduced, there is a discrepancy between downhole sequences from the data and the base-case model. Figure \ref{fig:data_sgs_runs} shows cumulative run length frequencies above the 0.9 quantile calculated directly from the data (red) and the expected value of gridded \gls{SGS} realizations (black). This discrepancy suggests additional high-grade continuity is required up to approximately 30m (six connected five-meter composites).

\begin{figure}[htb!]
    \centering
    \includegraphics[scale=0.75, max size={\textwidth}{\textheight}]{./0-Figures/06-Ch6/data_sgs_runs.png}
    \caption{Cumulative run length frequencies above the 0.9 quantile from the drillhole data and the base-case \gls{SGS} model.}
    \label{fig:data_sgs_runs}
\end{figure}

The decomposition of the continuous normal score variogram structures into individual components forms the initial latent Gaussian pool. Each nested variogram structure defines the covariance of a latent factor with zero nugget and sill of 1.0. As the continuous variogram also reproduces the indicator variograms, the initial pool consists of the two nested structures in Table \ref{tab:ns_expvar} for two initial factors. Additional structures are added to the pool that correspond with high-grade features of the conceptual geological model and the overall orientation of drilling. Factor 3 is strongly anisotropic in the vertical direction to capture the continuity of sub-vertical, high-grade breccia pipe structures. Ranges of the vertical factor are exaggerated as they will be reduces through mixing in the final model. The fourth and final factor is the nugget effect. As a pure nugget factor is added to the pool, any structure with a major range of less than 30 meters is pruned to prevent adding too much noise to the network inputs. Though the network can filter this noise, experiments show that some level of pruning improves the final parameter inference. Table \ref{tab:pool} shows the covariance structure of each component in the final pool, excluding the nugget factor. Factors 1 and 2 are from the normal score variogram model and factor 3 is the additional high-grade structure.


% Additional structures that correspond to high-grade clusters are added to the pool. The grade distribution is thresholded at the $95^{th}$ quantile, generating a binary indicator. Agglomerative clustering \citep{mullner2011modern} generates spatially coherent clusters using x, y, and z coordinates and the continuous variable. Cluster orientations and anisotropies are determined from the eigenvectors and eigenvalues of the 3x3 covariance matrix of cluster coordinates. The x, y, and z components of the eigenvectors form \gls{GSLIB} style rotation angles as:
% \begin{align}
%     \text{azm} & = 90 - \text{atan2}(y, x) * 180/\pi               \\
%     \text{dip} & = \text{atan2}(z, \sqrt{x^{2} + y^{2}}) * 180/\pi
%     \label{eq:azmdip}
% \end{align}

\begin{table}[!htb]
    \centering
    \caption{Covariance structures of the Gaussian pool (excluding the nugget).}
    \resizebox{0.9\width}{!}{\input{0-Tables/pool.tex}}
    \label{tab:pool}
\end{table}

The choice of activation function exponent, $\omega$, controls each factor's influence on either high or low values. $\omega < 1$ emphasizes low values (<0 in Gaussian units) and $\omega > 1$ emphasizes high values (>0 in Gaussian units). Table \ref{tab:omega} shows the minimum and maximum bound for each trainable $\omega$ parameter. Factors 1 and 2 are essentially unconstrained and free to influence either high or low values. Factor 3 is constrained to influence high values only. The nugget effect factor is constrained to $\omega=1$. The sigmoid weight parameter controls the weight to remaining factors when the factor with precedence is above or below a particular threshold. A negative weight emphasizes high values, and a positive weight emphasizes lows. As the weight magnitude increases, the threshold approaches zero and trends towards a binary step function. The weight to other factors is $\approx 0$ when $\mathbf{y}_{3} > 3.0$ with a sigmoid weight of -1.5.

\begin{table}[!htb]
    \centering
    \caption{$\omega$ bounds by factor.}
    \resizebox{0.9\width}{!}{\input{0-Tables/omega.tex}}
    \label{tab:omega}
\end{table}

The number of factors in the Gaussian pool dictates the network architecture. The pool consists of three structures, plus one for the nugget, for four latent Gaussian factors, resulting in an input layer of four nodes. Each input node has a single connection weight to a single hidden layer of the same dimension as the input. The network has $2 \cdot (M+1) = 8$ trainable parameters, four connection weights, and four $\omega$ values. Table \ref{tab:de_params} shows \gls{DE} parameters. The indicator thresholds used for optimization correspond to the indicator variograms in Section \ref{sec:06eda}, that is, $G^{-1}([0.1, 0.5, 0.9])$ where $G^{-1}$ is the inverse of the Gaussian \gls{CDF}. Runs consider a maximum of 10 steps ($\approx$50m).

\begin{table}[!htb]
    \centering
    \caption{Differential Evolution parameters.}
    \resizebox{0.9\width}{!}{\input{0-Tables/de_params.tex}}
    \label{tab:de_params}
\end{table}

Network optimization runs for 1500 iterations, resulting in a reasonably stable objective function value. The objective function value (Figure \ref{fig:fobj}) does not reach zero as it considers the expected value across all realizations. Though the objective function components are weighted, any deviation in the number of runs can lead to larger objective function values. Table \ref{tab:opt_omega} shows the final optimized connection weight and  $\omega$ parameters. Figure \ref{fig:nmropt_uncond_reals} shows plan-view, east-west and north-south sections through the first unconditional realization at the data locations generated by \texttt{NMROPT}. Objective components are calculated using these realizations.

% \begin{figure}[htb!]
%     \centering
%     \includegraphics[scale=0.75, max size={\textwidth}{\textheight}]{./0-Figures/06-Ch6/fobj.png}
%     \caption{\Gls{DE} objective value versus iteration.}
%     \label{fig:fobj}
% \end{figure}

% \begin{table}[!htb]
%     \centering
%     \caption{Optimal connection weight and $\omega$ parameters.}
%     \resizebox{0.9\width}{!}{\input{0-Tables/opt_omega.tex}}
%     \label{tab:opt_omega}
% \end{table}

\begin{figure}
    \begin{subfigure}[c]{0.5\textwidth}
        \centering
        \includegraphics[scale=0.5, max size={\textwidth}{\textheight}]{./0-Figures/06-Ch6/fobj.png}
        \caption{\Gls{DE} objective value versus iteration.}
        \label{fig:fobj}
    \end{subfigure}
    \begin{subfigure}[c]{0.5\textwidth}
        \centering
        \resizebox{0.9\width}{!}{\input{0-Tables/opt_omega.tex}}
        \caption{Optimal connection weight and $\omega$ parameters.}
        \label{tab:opt_omega}
    \end{subfigure}
    \caption{\Gls{DE} objective function value (a) and final optimized network parameters (b).}
    \label{}
\end{figure}


\begin{figure}
    \centering
    \tabskip=0pt
    \valign{#\cr
        \hbox{%
            \begin{subfigure}[b]{.55\textwidth}
                \centering
                \includegraphics[width=\textwidth]{./0-Figures/06-Ch6/nmropt_uncond_real0_xy.png}
                \caption{}
            \end{subfigure}%
        }\cr
        \noalign{\hfill}
        \hbox{%
            \begin{subfigure}{.45\textwidth}
                \centering
                \includegraphics[width=\textwidth]{./0-Figures/06-Ch6/nmropt_uncond_real0_xz.png}
                \caption{}
            \end{subfigure}%
        }\vfill
        \hbox{%
            \begin{subfigure}{.45\textwidth}
                \centering
                \includegraphics[width=\textwidth]{./0-Figures/06-Ch6/nmropt_uncond_real0_yz.png}
                \caption{}
            \end{subfigure}%
        }\cr
    }
    \caption{Plan (a), east-west (b) and north-south (c) sections through the first unconditional realization of Gaussian values generated by \texttt{NMROPT}. Objective function components are evaluated using these realizations. }
    \label{fig:nmropt_uncond_reals}
\end{figure}

A critical component of the \texttt{NMROPT} workflow is checking the reproduction of the optimization targets. Deviations from these targets will likely manifest in the imputed conditioning data and final realizations. Figures \ref{fig:nmropt_repro_vario} to \ref{fig:nmropt_repro_runs} show variogram, indicator variogram and cumulative run-length frequency reproduction with the optimal \gls{NMR} parameters. Variogram and indicator variogram reproduction are reasonable, though there is some deviation from the target models, particularly at shorter ranges in the principal directions. Cumulative run-length frequencies show good reproduction for all quantiles.

% This deviation comes at the expense of increasing high-grade (0.9 quantile) continuity in the drilling direction (roughly parallel to the tertiary variogram direction). This increased continuity is evident in the 0.9 quantile run-length frequency plot (Figure \ref{fig:nmropt_repro_runs} right) where the unconditional \texttt{NMROPT} realizations show continuity greater than that in the data. Consequently, the 0.1 and 0.5 quantiles show slightly decreased continuity relative to the data (Figure \ref{fig:nmropt_repro_runs} left and center). This increased continuity is advantageous as results show that the effect of conditioning in the final realizations can reduce extreme value continuity.

\begin{figure}[htb!]
    \centering
    \includegraphics[scale=0.60, max size={\textwidth}{\textheight}]{./0-Figures/06-Ch6/repro_vario.png}
    \caption{\texttt{NMROPT} continuous variogram reproduction for \csnreals \ realizations. The black line is the variogram model, the red line is the average variogram, and the shaded red area encloses the minimum and maximum variogram values. Left to right are the major, minor and vertical directions, respectively.}
    \label{fig:nmropt_repro_vario}
\end{figure}

\begin{figure}
    \begin{subfigure}{1.0\textwidth}
        \centering
        \includegraphics[scale=0.60, max size={\textwidth}{\textheight}]{./0-Figures/06-Ch6/repro_ivario_0_1.png}
        \caption{0.1 Quantile}
    \end{subfigure}
    \begin{subfigure}{1.0\textwidth}
        \centering
        \includegraphics[scale=0.60, max size={\textwidth}{\textheight}]{./0-Figures/06-Ch6/repro_ivario_0_5.png}
        \caption{0.5 Quantile}
    \end{subfigure}
    \begin{subfigure}{1.0\textwidth}
        \centering
        \includegraphics[scale=0.60, max size={\textwidth}{\textheight}]{./0-Figures/06-Ch6/repro_ivario_0_9.png}
        \caption{0.9 Quantile}
    \end{subfigure}
    \caption{\texttt{NMROPT} indicator variogram reproduction for \csnreals \ realizations for the 0.1 (a), 0.5 (b) and 0.9 (c) quantiles. Left to right are the major, minor and vertical directions, respectively. The black line is the variogram model, the red line is the average variogram, and the shaded red area encloses the minimum and maximum variogram values.}
    \label{fig:nmropt_repro_ivario}
\end{figure}

\begin{figure}[htb!]
    \centering
    \includegraphics[scale=0.60, max size={\textwidth}{\textheight}]{./0-Figures/06-Ch6/repro_runs.png}
    \caption{\texttt{NMROPT} cumulative run-length frequency reproduction for \csnreals \ realizations. Thresholds 1, 2, and 3 correspond to the 0.1, 0.5 and 0.9 quantiles. The black line is the target run-length frequency model, the red line is the average experimental value, and the shaded red area encloses the minimum and maximum experimental values.}
    \label{fig:nmropt_repro_runs}
\end{figure}


\FloatBarrier
\section{Latent Factor Imputation}
\label{sec:06fact_imp}

The optimized \gls{NMR} parameters from Section \ref{sec:06param} are the basis for latent factor imputation. The optimized mapping function, $\mathcal{F}_{\theta}$, and Gaussian pool are input to the program \texttt{NMRIMP}, simulating latent factor realizations via \gls{SGRI}. A high-grade constraint threshold at the 0.9 quantile (in Gaussian units) and an exclusion radius of 40 m are enforced for imputation. Enforcing the high-grade constraint ensures that some high values of the factor with precedence are seeded where the observed data values are high. The exclusion radius ensures that not all of these locations are seeded, as seed locations must be a minimum of 40 m apart. At the final seed locations, the value of the factor with precedence must be above the threshold. Seeding too many imputation locations may cause a strong departure from the standard normal distribution. Using the 0.9 quantile and a 40 m radius leads to $\approx 1.2\%$ of the data locations being seeded. \csnreals \ realizations are imputed for each factor specified in the Gaussian pool, plus the nugget effect. All imputed realizations are checked to ensure they (1) reproduce the data within the specified polishing tolerance (Table \ref{tab:imp_pars}); (2) imputed realizations are on average univariate Gaussian; (3) imputed factors are on average uncorrelated, and (4) each imputed factor on average reproduces its single structure variogram model.

\begin{table}[!htb]
    \centering
    \caption{\texttt{NMRIMP} parameters.}
    \resizebox{0.9\width}{!}{\input{0-Tables/imp_pars.tex}}
    \label{tab:imp_pars}
\end{table}

Figure \ref{fig:imputed_scatters} shows a scatter plot matrix of the original data values, plus the first realization of the mapped imputed values and all latent factors. Scatters are coloured by \gls{KDE} where warmer colours correspond to a higher density of points. The top row of the matrix is somewhat redundant; however, it highlights the perfect correlation between the observed data and mapped imputed values. The marginal histograms show that each latent distribution is standard normal, with reasonable statistical fluctuation. The scatter plots between each latent factor show roughly concentric bivariate Gaussian density contours and $|\rho| < 0.10$. The average correlation coefficient across all realizations is within this tolerance, suggesting the latent factors are effectively uncorrelated. Figure \ref{fig:nmrimp_repro_gvario} shows variogram reproduction for each imputed factor. There is some deviation from the specified target models, though overall, variogram reproduction is reasonable. Deviation from the specified model is largely present in factor 2, which shows decreased short-range continuity. This deviation is attributed to the effect of strong conditioning and does not appear to impart any negative consequences in the final \gls{NMR} model.

\begin{figure}[htb!]
    \centering
    \includegraphics[scale=0.75, max size={\textwidth}{\textheight}]{./0-Figures/06-Ch6/imputed_scatters.png}
    \caption{Scatter plot matrix coloured by \gls{KDE} illustrating the relationships between the observed data values, mapped imputed values and latent factors in Gaussian units. The histograms show the marginal distributions of each variable by row. }
    \label{fig:imputed_scatters}
\end{figure}

\begin{figure}
    \begin{subfigure}{1.0\textwidth}
        \centering
        \includegraphics[scale=0.60, max size={\textwidth}{\textheight}]{./0-Figures/06-Ch6/expvario_fact1.png}
        \caption{Factor 1}
    \end{subfigure}
    \begin{subfigure}{1.0\textwidth}
        \centering
        \includegraphics[scale=0.60, max size={\textwidth}{\textheight}]{./0-Figures/06-Ch6/expvario_fact2.png}
        \caption{Factor 2}
    \end{subfigure}
    \begin{subfigure}{1.0\textwidth}
        \centering
        \includegraphics[scale=0.60, max size={\textwidth}{\textheight}]{./0-Figures/06-Ch6/expvario_fact3.png}
        \caption{Factor 3}
    \end{subfigure}
    % \begin{subfigure}{1.0\textwidth}
    %     \centering
    %     \includegraphics[scale=0.60, max size={\textwidth}{\textheight}]{./0-Figures/06-Ch6/expvario_fact4.png}
    %     \caption{Factor 4}
    % \end{subfigure}
    \caption{Variogram reproduction for \csnreals \ imputed realizations of each factor. The black line is the variogram model, the red line is the average variogram, and the shaded red area encloses the minimum and maximum variogram values. Table \ref{tab:pool} specifies the Gaussian pool.}
    \label{fig:nmrimp_repro_gvario}
\end{figure}


\FloatBarrier
\section{Latent Factor Simulation}
\label{sec:06fact_sim}

Imputed factor realizations from Section \ref{sec:06fact_imp} become conditioning data for gridded factor realizations. Each univariate Gaussian factor realization conditions a gridded realization in a one-for-one fashion. That is, each simulated realization uses a unique data realization. Gridded realizations in this case study are simulated using \gls{SGS} though any conditional simulation algorithm is valid. The point scale simulation grid utilizes a cell size of 2.5 x 2.5 x 5m for 2,236,948 nodes; Table \ref{tab:simgrid} summarizes the parameters of the grid. \csnreals \ realizations of each factor are simulated and checked similarly to any other Gaussian simulation workflow \citep{leuangthong2004minimum}. The realizations are, on average, univariate Gaussian and reproduce the variogram. Figure \ref{fig:gridded_factors_with_indicator_real1} shows an east-west section through the first gridded realization of the latent factors to highlight the effect of seeding a particular factor. The fourth panel shows the 0.9 quantile indicator transform of the latent factors mapped to observed space with the 0.9 quantile indicator transform of the Gaussian variable. As factor 3 is seeded and given high-grade preference during imputation, the latent high-grade features correspond with high-grade regions in the observed data.

\begin{table}[!htb]
    \centering
    \caption{Simulation grid parameters.}
    \resizebox{0.9\width}{!}{\input{0-Tables/simgrid.tex}}
    \label{tab:simgrid}
\end{table}

\begin{figure}[htb!]
    \centering
    \includegraphics[scale=0.5, max size={\textwidth}{\textheight}]{./0-Figures/06-Ch6/gridded_factors_with_indicator_real3.png}
    \caption{East-west section through the first realization of the gridded factors, plus the 0.9 quantile indicator transform of the latent factors mapped to observed space.}
    \label{fig:gridded_factors_with_indicator_real1}
\end{figure}

Once factors are defined at all grid nodes, they are mapped from latent to observed space by applying $\mathcal{F}_{\theta}(\mathbf{y})$ where $\mathbf{y}$ is the vector of gridded Gaussian realizations. Mapping consists of interpolating the raw activation values (the \gls{NMR} output) with the normal score reference distribution generated by \texttt{NMRIMP}. Using a single reference distribution ensures consistency between imputation and gridded simulation. The \gls{NMR} realizations are checked to ensure they reproduce the continuous variogram model, indicator variogram models, and cumulative run-length frequencies, and the realizations are, on average, univariate Gaussian. Figure \ref{fig:ns_reals} shows plan-view, east-west and north-south sections through the first \gls{NMR} realization mapped to Gaussian units. Figure \ref{fig:repro_gridded_cdfs} shows \gls{CDF} reproduction of the \gls{NMR} realizations in Gaussian units (left panel). The realizations show reasonable variance given the level of conditioning and are, on average, univariate Gaussian. Figure \ref{fig:orig_reals} shows plan-view, east-west and north-south sections through the first \gls{NMR} realization back-transformed to original units. These figures show the vertical and downhole high-grade continuity imparted by factors 3 and 4 (Table \ref{tab:pool}). The overall background continuity imparted by the continuous variogram model dips to the east, and is clear in the east-west sections (Figure \ref{fig:orig_reals} (b)). Figure \ref{fig:repro_gridded_cdfs} shows \gls{CDF} reproduction of the \gls{NMR} realizations in back-transformed to original units (right panel). The realizations reproduce the declustered histogram of the training data well.

% \foreach \sec/\name in \sectuples
% {
%     \begin{figure}[htb!]
%         \centering
%         \includegraphics[scale=0.5, max size={\textwidth}{\textheight}]{./0-Figures/06-Ch6/ns_reals_\sec.png}
%         \caption{ \name \ sections through the first \gls{NMR} realization mapped to Gaussian units. }
%         \label{fig:ns_reals_\sec}
%     \end{figure}
% }

\begin{figure}
    \centering
    \tabskip=0pt
    \valign{#\cr
        \hbox{%
            \begin{subfigure}[b]{.55\textwidth}
                \centering
                \includegraphics[width=\textwidth]{./0-Figures/06-Ch6/ns_reals_xy.png}
                \caption{}
            \end{subfigure}%
        }\cr
        \noalign{\hfill}
        \hbox{%
            \begin{subfigure}{.45\textwidth}
                \centering
                \includegraphics[width=\textwidth]{./0-Figures/06-Ch6/ns_reals_xz.png}
                \caption{}
            \end{subfigure}%
        }\vfill
        \hbox{%
            \begin{subfigure}{.45\textwidth}
                \centering
                \includegraphics[width=\textwidth]{./0-Figures/06-Ch6/ns_reals_yz.png}
                \caption{}
            \end{subfigure}%
        }\cr
    }
    \caption{Plan (a), east-west (b) and north-south (c) sections through the first \gls{NMR} realization mapped to Gaussian units.}
    \label{fig:ns_reals}
\end{figure}

\begin{figure}
    \begin{subfigure}{0.5\textwidth}
        \centering
        \includegraphics[scale=0.6, max size={\textwidth}{\textheight}]{./0-Figures/06-Ch6/repro_gridded_ns_cdf.png}
    \end{subfigure}
    \begin{subfigure}{0.5\textwidth}
        \centering
        \includegraphics[scale=0.6, max size={\textwidth}{\textheight}]{./0-Figures/06-Ch6/repro_gridded_cdf.png}
    \end{subfigure}
    \caption{\gls{CDF} reproduction for \csnreals \ \gls{NMR} realizations mapped to Gaussian units (left) and original units (right).}
    \label{fig:repro_gridded_cdfs}
\end{figure}

% \foreach \sec/\name in \sectuples
% {
%     \begin{figure}[htb!]
%         \centering
%         \includegraphics[scale=0.5, max size={\textwidth}{\textheight}]{./0-Figures/06-Ch6/orig_real0_\sec.png}
%         \caption{ \name \ sections through the first \gls{NMR} realization back-transformed to original units. }
%         \label{fig:orig_reals_\sec}
%     \end{figure}
% }

\begin{figure}
    \centering
    \tabskip=0pt
    \valign{#\cr
        \hbox{%
            \begin{subfigure}[b]{.55\textwidth}
                \centering
                \includegraphics[width=\textwidth]{./0-Figures/06-Ch6/orig_real0_xy.png}
                \caption{}
            \end{subfigure}%
        }\cr
        \noalign{\hfill}
        \hbox{%
            \begin{subfigure}{.45\textwidth}
                \centering
                \includegraphics[width=\textwidth]{./0-Figures/06-Ch6/orig_real0_xz.png}
                \caption{}
            \end{subfigure}%
        }\vfill
        \hbox{%
            \begin{subfigure}{.45\textwidth}
                \centering
                \includegraphics[width=\textwidth]{./0-Figures/06-Ch6/orig_real0_yz.png}
                \caption{}
            \end{subfigure}%
        }\cr
    }
    \caption{Plan (a), east-west (b) and north-south (c) sections through the first \gls{NMR} realization back-transformed to original units.}
    \label{fig:orig_reals}
\end{figure}


Figure \ref{fig:repro_gridded_vario} shows gridded continuous variogram reproduction for the \gls{NMR} realizations in Gaussian units. The experimental variogram of the first imputed data realization and the average of \gls{SGS} realizations are shown for reference. There is reasonable agreement between the target model (black line), the imputed data (red dots) and the gridded realization average (red line). There is some deviation; however, these are the same deviations present from the inference of the network parameters (Figure \ref{fig:nmropt_repro_vario}). Indicator variogram reproduction in Figure \ref{fig:repro_gridded_ivario} shows similar deviations observed in the optimization process, though the gridded variograms reproduce the target model and imputed data reasonably well. Figure \ref{fig:repro_gridded_runs} shows gridded cumulative run-length frequency reproduction for both the \gls{NMR} and \gls{SGS} realizations, respectively. The expected value of the \gls{SGS} realizations is shown as the solid black line. As expected, the \gls{NMR} realizations show increased continuity over \gls{SGS} for all connected steps up to a run length of 6 composites. This increase in downhole continuity is consistent with observations made when designing the Gaussian pool (Figure \ref{fig:data_sgs_runs}).

\begin{figure}[htb!]
    \centering
    \includegraphics[scale=0.60, max size={\textwidth}{\textheight}]{./0-Figures/06-Ch6/repro_gridded_vario.png}
    \caption{\gls{NMR} normal score variogram reproduction for \csnreals \ realizations. The black line is the variogram model, the red dots are the experimental variogram of the imputed data, the red line is the average variogram of the gridded \gls{NMR} realizations, the shaded red area encloses the minimum and maximum gridded \gls{NMR} variogram values, and the dashed grey line is the average variogram of the gridded \gls{SGS} realizations. Left to right are the major, minor and vertical directions, respectively.}
    \label{fig:repro_gridded_vario}
\end{figure}

\begin{figure}
    \begin{subfigure}{1.0\textwidth}
        \centering
        \includegraphics[scale=0.60, max size={\textwidth}{\textheight}]{./0-Figures/06-Ch6/repro_gridded_ivario_0_1.png}
        \caption{0.1 Quantile}
    \end{subfigure}
    \begin{subfigure}{1.0\textwidth}
        \centering
        \includegraphics[scale=0.60, max size={\textwidth}{\textheight}]{./0-Figures/06-Ch6/repro_gridded_ivario_0_5.png}
        \caption{0.5 Quantile}
    \end{subfigure}
    \begin{subfigure}{1.0\textwidth}
        \centering
        \includegraphics[scale=0.60, max size={\textwidth}{\textheight}]{./0-Figures/06-Ch6/repro_gridded_ivario_0_9.png}
        \caption{0.9 Quantile}
    \end{subfigure}
    \caption{\gls{NMR} indicator variogram reproduction for \csnreals \ realizations for the 0.1 (a), 0.5 (b) and 0.9 (c) quantiles. The black line is the variogram model, the red dots are the experimental variogram of the imputed data, the red line is the average variogram of the gridded \gls{NMR} realizations, the shaded red area encloses the minimum and maximum gridded \gls{NMR} variogram values, and the dashed grey line is the average variogram of the gridded \gls{SGS} realizations. Left to right are the major, minor and vertical directions, respectively.}
    \label{fig:repro_gridded_ivario}
\end{figure}

\begin{figure}[htb!]
    \centering
    \includegraphics[scale=0.75, max size={\textwidth}{\textheight}]{./0-Figures/06-Ch6/repro_gridded_runs.png}
    \caption{\gls{NMR} 0.9 quantile cumulative run-length frequency reproduction for \csnreals \ realizations. 0.9 quantile from \gls{SGS} is shown for reference.}
    \label{fig:repro_gridded_runs}
\end{figure}

\FloatBarrier
\section{Post Processing}
\label{sec:06post}

Point scale realizations are block-averaged to the \gls{SMU} volume for comparison at a relevant scale. The \gls{SMU} scale grid extents are consistent with the simulation grid, though subsequent analyses are focused on the west-southwest portion of the grid that encompasses most of the test set. Table \ref{tab:smugrid} shows the parameters of the \gls{SMU} grid. As a goal of the \gls{NMR} is to improve local high-grade resources conditional to certain events, a simplified stope optimization process is implemented to mimic the selection of local high-grade resources at the \gls{SMU} scale. The reference \gls{OK} model from Section \ref{sec:06eda} is used for stope optimization. Stopes with a fixed footprint of 30 x 30 m and a minimum height of 40 m are selected considering the \gls{OK} reference model and a \gls{COG} of 2.0 units. An initial grid of stope footprint centroids is generated across the reference model. All valid footprints about the centroid are evaluated, and the highest grade stope meeting the minimum volume requirement is selected. The initial stope's z-dimension is then expanded one grid level at a time until the volume is no longer above \gls{COG} or a maximum height of 80 m is reached. This process is simplified and intended to be a straightforward proxy for mining selectivity. The resulting volumes are not true optimums. Figure \ref{fig:stopes_testdata_xy} shows a plan view section through the reference \gls{OK} model showing the stope shapes and the test data locations.

\begin{table}[!htb]
    \centering
    \caption{\Gls{SMU} grid parameters.}
    \resizebox{0.9\width}{!}{\input{0-Tables/smugrid.tex}}
    \label{tab:smugrid}
\end{table}

\begin{figure}[htb!]
    \centering
    \includegraphics[scale=0.50, max size={\textwidth}{\textheight}]{./0-Figures/06-Ch6/stopes_testdata_xy.png}
    \caption{Plan view section through the reference \gls{OK} model showing stope shapes and the test dataset. }
    \label{fig:stopes_testdata_xy}
\end{figure}

Stopes containing composites from the test dataset are used to evaluate the performance of the \gls{NMR} realizations relative to \gls{SGS} in local, high-grade regions of the model. The test composites are coded by stope ID and compared directly to simulated realizations within the same volume. The following section summarizes model performance.

\FloatBarrier
\section{Model Comparison}
\label{sec:06compare}

The following section compares the \gls{NMR} and \gls{SGS} realizations at a global scale and conditional to high-grade stope volumes. These tests show how well each set of realizations reproduces data the model has not seen. The main focus of the \gls{NMR} implementation is getting the high-grade connectivity correct at the local stope volume. Modeling results are discussed globally across all test set data locations and locally within high-grade stope volumes. Recall from Figure \ref{fig:datasets} that the test set is systematically higher grade than the training set. Though the conceptual geologic model is embedded in the \gls{NMR}, it is unrealistic to expect a data-driven model to reproduce unseen data that is significantly higher or lower grade. For this reason, stopes where the deviation between the test and training set's mean grade is greater than $20\%$ are excluded from the comparison. Spatially partitioning complete drillholes into training and test sets with balanced features may not always be possible with geologic data.

\subsection{Global Results}
\label{subsec:06global}

The most straightforward check of model performance is the prediction error at test set locations. Each value from the test set is compared to the simulated value at the data location for both \gls{NMR} and \gls{SGS} models. The prediction error is the difference between the true and simulated data values. Figure \ref{fig:all_data_error_dist} shows the distributions of prediction errors across all realizations for both the \gls{NMR} and \gls{SGS} models. Both histograms are symmetric and centered about zero. The \gls{NMR} model shows a slight reduction in error with a mean of $-0.13$ versus $-0.14$ for the \gls{SGS} model. The negative means indicate that both models underestimate the true values, which is expected due to the increased mean grade of the test set relative to the training set. Figure \ref{fig:all_data_error_xval} shows cross-validation scatter plots between \gls{NMR} and \gls{SGS} realizations and true data values. Again, the \gls{NMR} model shows similar \gls{RMSE} and the correlation between the estimate and the truth.

\begin{figure}[htb!]
    \centering
    \includegraphics[scale=0.6, max size={\textwidth}{\textheight}]{./0-Figures/06-Ch6/all_data_error_dist.png}
    \caption{Distributions of prediction error for \gls{NMR} (left) and \gls{SGS} models (right) at all test set locations. }
    \label{fig:all_data_error_dist}
\end{figure}

\begin{figure}[htb!]
    \centering
    \includegraphics[scale=0.6, max size={\textwidth}{\textheight}]{./0-Figures/06-Ch6/all_data_error_xval.png}
    \caption{Cross validation scatter plots of  \gls{NMR} (left) and \gls{SGS} (right) models and true data values at all test set locations. The black line is 1:1, and the red line is the regression of the truth on the estimate. RMSE=root mean squared error; SoR=slope of regression.}
    \label{fig:all_data_error_xval}
\end{figure}

Probabilistic accuracy can be assessed by considering the local conditional \glspl{CDF} defined by the set of simulated realizations at the test set locations. Probabilistic accuracy amounts to checking the number of true values that fall within a given probability interval. For example, 50\% of the true values should fall within the 0.5 probability interval (between the $25^{th}$ and  $75^{th}$ quantiles). The true value comes from the test set, and the realizations define the probability interval. Accuracy plots are generated by plotting the actual fraction of true values within the interval against the probability interval. An accurate and precise model will plot with points close to the 45-degree line. Figure \ref{fig:nmr_sgs_acc_plot} shows accuracy plots for the \gls{NMR} and \gls{SGS} models. Both models plot close to the 45-degree line, suggesting reasonable modeling techniques. Uncertainty is slightly wide for the \gls{NMR} model, meaning the realizations are slightly higher variance compared to the test set; the same is true for the \gls{SGS} model. The acceptable width tolerance is set to 5\%; for both models, the average error (probability interval - fraction in interval) is less than this threshold. Accuracy and precision metrics are reported for a quantitative measure. However, little deviation from the 1:1 line is the most important feature \citep{deutsch2010display} .

\begin{figure}[htb!]
    \centering
    \includegraphics[scale=0.6, max size={\textwidth}{\textheight}]{./0-Figures/06-Ch6/nmr_sgs_acc_plot.png}
    \caption{Accuracy plots of  \gls{NMR} (left) and \gls{SGS} (right) models at all test set locations. $n_{p}$ is the number of probability intervals. }
    \label{fig:nmr_sgs_acc_plot}
\end{figure}

At a global scale, the \gls{NMR} model shows a modest improvement in prediction error, both in magnitude and \gls{RMSE} with the truth. Both \gls{NMR} and \gls{SGS} models show good accuracy at the global scale. The following section explores validation metrics at the local scale; the goal is that the \gls{NMR} outperforms \gls{SGS} conditional to high-grade stope volumes.

\subsection{Local Results}
\label{subsec:06local}

Local results consider test set locations that fall within stope volumes. Prediction error, \gls{RMSE} and accuracy plots are checked within stope volumes. \Gls{GT} curves are checked for all stope volumes and on a stope-by-stope basis. Stopes where the \gls{NMR} outperforms \gls{SGS} are investigated in greater detail. The \gls{NMR} shows modest improvements compared to \gls{SGS} overall. However, some stopes exist where \gls{SGS} is superior. These stopes are also investigated in greater detail. Figure \ref{fig:stope_error_dist} shows distributions of prediction error for the \gls{NMR} and \gls{SGS} models. Again, the \gls{NMR} shows a slight improvement with a mean error closer to zero than the \gls{SGS} error distribution. Figure \ref{fig:stope_error_xval} shows cross-validation scatter plots for true and predicted values across all realizations for both models. The \gls{NMR} model shows similar results in terms of \gls{RMSE} and correlation coefficient relative to the \gls{SGS} model.

\begin{figure}[htb!]
    \centering
    \includegraphics[scale=0.6, max size={\textwidth}{\textheight}]{./0-Figures/06-Ch6/stope_error_dist.png}
    \caption{Distributions of prediction error for \gls{NMR} (left) and \gls{SGS} models (right) at test set locations flagged within stope volumes. }
    \label{fig:stope_error_dist}
\end{figure}

\begin{figure}[htb!]
    \centering
    \includegraphics[scale=0.6, max size={\textwidth}{\textheight}]{./0-Figures/06-Ch6/stope_error_xval.png}
    \caption{Cross validation scatter plots of  \gls{NMR} (left) and \gls{SGS} (right) models and true data values at test set locations flagged within stope volumes. The black line is 1:1, and the red line is the regression of the truth on the estimate. RMSE=root mean squared error; SoR=slope of regression.}
    \label{fig:stope_error_xval}
\end{figure}

Figure \ref{fig:nmr_sgs_stope_acc_plot} shows accuracy plots for test set data values flagged within stope volumes. Again, both models plot close to the 45-degree line though the \gls{NMR} model slightly under-predicts local uncertainty compared to all test set locations in Figure \ref{fig:nmr_sgs_acc_plot}. This reduction of local uncertainty is likely due to the effect of strong conditioning and constraints enforced during the imputation of factor 3 in high-grade locations. The \gls{SGS} model shows similar accuracy within the stope volumes.

\begin{figure}[htb!]
    \centering
    \includegraphics[scale=0.6, max size={\textwidth}{\textheight}]{./0-Figures/06-Ch6/nmr_sgs_stope_acc_plot.png}
    \caption{Accuracy plots of  \gls{NMR} (left) and \gls{SGS} (right) models at all test set locations. $n_{p}$ is the number of probability intervals. }
    \label{fig:nmr_sgs_stope_acc_plot}
\end{figure}

Figure \ref{fig:nmr_sgs_gtcurve_all_stopes} shows \gls{GT} curves for all stope volumes for the \gls{NMR} (left) and \gls{SGS} (right) \gls{SMU} scale realizations. Test data tonnes and grades come from weighted composites in the test set flagged within the stope volumes. Across all stopes, the \gls{SGS} model is similar in grade and higher in tonnage than the test composites. \gls{NMR} realizations are overall lower in grade and tonnage relative to the \gls{SGS} realizations and more closely reproduce the test data. This reproduction is likely due to the anisotropies of certain factors constraining high-grade features rather than being controlled by a single continuous variogram (that considers the full range of grade values) in the \gls{SGS} context.

\begin{figure}[htb!]
    \centering
    \includegraphics[scale=0.6, max size={\textwidth}{\textheight}]{./0-Figures/06-Ch6/nmr_sgs_gtcurve_all_stopes.png}
    \caption{\Gls{GT} curves for all stope volumes for the \gls{NMR} (left) and \gls{SGS} (right) models.}
    \label{fig:nmr_sgs_gtcurve_all_stopes}
\end{figure}

Table \ref{tab:nmr_sgs_stope_delta} shows more detailed grade and test set deviation on a stope-by-stope basis. The table shows the number of test data in each stope, the mean grade of the composites, and the percent deviation from the test data mean for the \gls{OK}, \gls{SGS} and \gls{NMR} expected values. Training and test set mean values are the declustered mean grade of the respective data set, flagged within the stope volume. Gridded mean values are the equal-weighted mean of all blocks flagged with that stope ID, as no density data is available. Values are sorted in ascending order by the training set mean grade. In some situations, all models perform poorly, both over- and under-estimating the mean of the test data. These large deviations occur in stopes where the training and testing data are unbalanced. That is, there is a significant deviation between the mean of the conditioning data and the mean of the hold-out data. Figure \ref{fig:test_train_deviation} shows the percent deviation from the test data mean for the training data and \gls{NMR} and \gls{SGS} expected values within each stope. Subsequent comparisons consider stopes where this deviation is less than 20\%. Where the training and testing data are balanced concerning grade, the \gls{NMR} model performs well relative to \gls{SGS}, particularly in higher grade stopes. For stopes 39, 158 and 40, the \gls{NMR} shows improvement over \gls{SGS}, with stope 39 showing a 7\% improvement relative to the test set mean. Notably, the \gls{NMR} almost always under-predicts the mean relative to \gls{SGS}. All other stopes show minor improvements except for stope 641, 47 and 1138, where the test set mean is greater than the training set and the \gls{NMR} under-predicts.


\begin{figure}[htb!]
    \centering
    \includegraphics[scale=0.5, max size={\textwidth}{\textheight}]{./0-Figures/06-Ch6/test_train_deviation.png}
    \caption{Percent deviation from the test data set by stope ID. Stopes where train/test deviation is less than 20\% are retained for comparison. }
    \label{fig:test_train_deviation}
\end{figure}

\begin{table}[!htb]
    \centering
    \caption{\% difference in expected value between \gls{OK} mean, \gls{SGS} expected value and \gls{NMR} expected value relative to test set mean by stope ($\geq 2.0$ unit \gls{COG}). The table shows stopes with greater than 30 test data and test set deviation of less than 20\%. Values are sorted in ascending order by training data mean value.}
    \resizebox{0.9\width}{!}{\input{0-Tables/nmr_sgs_stope_delta.tex}}
    \label{tab:nmr_sgs_stope_delta}
\end{table}

\begin{figure}[htb!]
    \centering
    \includegraphics[scale=0.5, max size={\textwidth}{\textheight}]{./0-Figures/06-Ch6/stope_mean_grades.png}
    \caption{Mean grades by stope ID where test set deviation is less than 20\%, and at least 30 data are present in the stope volume. }
    \label{fig:stope_mean_grades}
\end{figure}

Stope 39 is a high-grade stope where the \gls{NMR} performs well relative to \gls{SGS}. Figure \ref{fig:nmr_sgs_gtcurve_stope39} shows the \gls{NMR} vs \gls{SGS} \gls{GT} curve for stope 39. These \gls{GT} curves show similar characteristics to Figure \ref{fig:nmr_sgs_gtcurve_all_stopes} where the \gls{SGS} model is higher grade through virtually all cutoff grades. The \gls{NMR} model shows slightly better reproduction of the test composites grades and the fraction of total tonnes above \gls{COG}. Figure \ref{fig:stope39_test_data} shows east-west sections though the spatial centroid of stope 39 with the reference \gls{OK} model, the \gls{SGS} e-type and the \gls{NMR} e-type models with the training and test data. Visually, the \gls{NMR} realization does a good job of reproducing the test data, and vertical high-grade continuity imparted by factor 3 is apparent. Stope 47 is a high-grade stope where \gls{SGS} performs well relative to the \gls{NMR}. Figure \ref{fig:nmr_sgs_gtcurve_stope47} shows the \gls{NMR} vs \gls{SGS} \gls{GT} curve for stope 47. The \gls{NMR} model appears to reproduce the grade of the test composites well; however, the tonnage above cutoff is less for almost all cutoffs. This reduction in tonnage above cutoff leads to a lower expected value relative to the test set and \gls{SGS}. Factor 3 imparts vertical continuity visible to the east of the stope volume in the bottom panel of Figure \ref{fig:stope47_test_data}. Rather than east-dipping continuity characterized by the continuous variogram, this vertical continuity constrains the high-grade mineralization between the training set drillholes. This constraint underestimates the test set grades given the deterministic model with anisotropy defined by the continuous variogram.

% good stope
\begin{figure}[htb!]
    \centering
    \includegraphics[scale=0.5, max size={\textwidth}{\textheight}]{./0-Figures/06-Ch6/nmr_sgs_gtcurve_stope39.png}
    \caption{\Gls{GT} curves for stope 39 for \gls{NMR} (left) and \gls{SGS} (right) models. Stope 39 is a high-grade stope where the \gls{NMR} performs well relative to \gls{SGS}.}
    \label{fig:nmr_sgs_gtcurve_stope39}
\end{figure}

\begin{figure}[htb!]
    \centering
    \includegraphics[scale=0.4, max size={\textwidth}{\textheight}]{./0-Figures/06-Ch6/stope39_test_data.png}
    \caption{Sections through stope 39 showing the test data, \gls{OK} model, and the first block averaged realization of the \gls{SGS} and \gls{NMR} models. Stope 39 is a high-grade stope where the \gls{NMR} performs well relative to \gls{SGS}. Training data is outlined in gray circles, while test data is in black.}
    \label{fig:stope39_test_data}
\end{figure}

% bad stope
\begin{figure}[htb!]
    \centering
    \includegraphics[scale=0.5, max size={\textwidth}{\textheight}]{./0-Figures/06-Ch6/nmr_sgs_gtcurve_stope47.png}
    \caption{\Gls{GT} curves for stope 47 for \gls{NMR} (left) and \gls{SGS} (right) models. Stope 47 is a high-grade stope where \gls{SGS} performs well relative to the \gls{NMR}.}
    \label{fig:nmr_sgs_gtcurve_stope47}
\end{figure}

\begin{figure}[htb!]
    \centering
    \includegraphics[scale=0.4, max size={\textwidth}{\textheight}]{./0-Figures/06-Ch6/stope47_test_data.png}
    \caption{Sections through stope 47 showing the test data, \gls{OK} model, and the first block averaged realization of the \gls{SGS} and \gls{NMR} models. Stope 47 is a high-grade stope where \gls{SGS} performs well relative to the \gls{NMR}. Training data is outlined in gray circles, while test data is in black. }
    \label{fig:stope47_test_data}
\end{figure}

Throughout all cutoff grades the \gls{NMR} realizations are lower grade than the \gls{SGS} realizations. This reduction in grade leads to better reproduction of the test data across all stope volumes. However, discrepancies exist stope-by-stope. The \gls{NMR} outperforms \gls{SGS} when \gls{SGS} overestimates the true grade. If \gls{SGS} underestimates the true grade, typically the \gls{NMR} further underestimates. This phenomenon is likely due to strongly anisotropic latent factors imparting high-grade continuity (factor 3) that form a ``hard'' boundary with background mineralization. This feature is evident in the bottom panel of Figure \ref{fig:stope39_test_data} where sharper vertical boundaries are present between high-grade structures (>3.0 units) and lower-grade background mineralization. Stope placement, considering a smooth deterministic model, may not be able to capture these features adequately in probabilistic realizations.

\FloatBarrier
\section{Discussion}
\label{sec:06discuss}

The \gls{NMR} can reproduce high-grade continuity features that cannot be captured with a continuous variogram alone. The specification of $\omega$ bounds allows the practitioner to impart specific spatial features onto specific portions of the continuous grade range. The resulting \gls{NMR} realizations are univariate Gaussian; however, they capture non-Gaussian connectivity features. In this case study, the connectivity of extreme values is particularly important. A base-case \gls{SGS} model shows that realizations generated under a multivariate-Gaussian assumption cannot alone capture the high-grade continuity observed in the drillholes. The \gls{NMR} parameter inference workflow determines the optimal weight of each factor and the exponent $\omega$ for the network activation function. Parameters are optimized to reproduce continuous and indicator variograms and cumulative run-length frequencies observed in the drillhole data in the final gridded realizations. The indicator variograms do not show significant asymmetry in this case study, though the \gls{NMR} can reproduce these non-Gaussian features. In addition, high-grade continuity, above what is observed in the drillholes, is embedded in the \gls{NMR} through highly anisotropic factors where $\omega \ge 1$. This increased continuity is required when the conditional simulation of the Gaussian factors leads to the destructuring of extreme values after passing through the \gls{NMR}.

Across all stope volumes, the \gls{NMR} realizations more accurately reproduce the grade and tonnage of the test dataset than the \gls{SGS} realizations. On a stope-by-stope basis, the performance of the \gls{NMR} model is variable, though major deviations in grade between the train and test composites within any given stope should be considered. For critical stopes such as stopes 39, 40, and 158 the \gls{NMR} shows up to a 7\% improvement relative to a conventional \gls{SGS} workflow. This improvement is modest, but deemed significant in a local, high-grade context. Comparison of composite averages to stope volume expected values is assumed to be an adequate proxy to production reconciliation data; this ``test'' dataset scenario is likely as close as we can get without having true as-mined shapes and production grade information. It is also important to note that the stope optimization workflow is not generating a true optimal shape. The stope shapes are a geotechnically feasible, heuristic proxy to mimic the mining selectivity.


