%!TEX root = ../Thesis_example_compile_this.tex

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\chapter{NMR Framework}
\label{ch:03framework}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{enumerate}
    \item some discussion regarding mining's focus on high-grades rather than low
    \item introduce how the goal of the NMR is to get higher order connectivity
\end{enumerate}



\FloatBarrier
\section{Inverse Problems}
\label{sec:03inverse}

\subsection{Inversion Considerations}
\label{subsec:03invconsider}


\FloatBarrier
\section{Connectivity and Non‐Gaussianity}
\label{sec:03connect}

A sequence is a collection of elements where the order of those elements matters. The arrangement or order of the elements can be used to characterize the connectivity within the sequence. A drillhole or well represents a one-dimensional sequence of real numbers in a geostatistical context. Connectivity of high and low values is often of practical importance, mainly when the transfer function is sensitive to extreme values. A one-dimensional sequence provides access to data-driven multiple-point configurations or patterns that would be difficult to infer in two- or three-dimensions. Connectivity is a different way of measuring correlation within a sequence. Each drillhole can be considered an exhaustive, one-dimensional training image from which $n\text{-point}$ statistics can be inferred.

A natural extension of this concept is the analysis of runs of binary sequences from linear strings of data \citep{ortiz2003characterization}. A binary sequence is either 0 or 1 and is achieved through the indicator transform of a continuous \gls{RV}. For a given threshold $z_{k}, \ k=1,\dots,K$:
\begin{equation}
    I(\mathbf{u}_{i};z_{k}) =
    \begin{cases}
        1, & \text{ if }z(\mathbf{u}_{i}) \leq z_{k} \\
        0, & \text{ otherwise }                      \\
    \end{cases}
    \label{eq:indicator}
\end{equation}

It is common to consider multiple thresholds resulting in multiple binary sequences. A \emph{run} of length $L$ is defined as $L$ identical values bound on either end by an opposite value. Runs of consecutive values above or below the threshold can be assessed. The theory of the distributions of runs for random uniform sequences is well documented by \cite{mood1940distribution}; the moments of the distribution of runs have analytical expressions, and it is shown that the limit distributions are normal. Though useful in many applications like cryptography and random number generation \citep{rukhin2010statistical}, the assumption of independence between elements in the sequence is limiting in the spatially correlated scenario.

\cite{ortiz2003characterization} shows that the analytical derivation of multi-point events is only possible when the multivariate spatial law is known. Practically, this is either the random or multivariate Gaussian case. A run of length $L$ above a threshold $z_{k}$ consists of $L+2$ elements where the first and last elements are below the threshold. In the general case, the probability of a run of length $L$ is defined as:
\begin{align}
    \begin{split}
        P\{\text{run L}\} & =                                                                                                                                                                \\
                          & P\{Z(\mathbf{u}) \leq z_{k}| Z(\mathbf{u + h}) > z_{k},\dots, Z(\mathbf{u} + L \cdot \mathbf{h}) > z_{k}, Z(\mathbf{u} + (L+1)) \leq z_{k}\} \cdot ,\dots, \cdot \\
                          & P\{Z(\mathbf{u} + L \cdot \mathbf{h}) > z_{k} | Z(\mathbf{u} + (L+1)) \leq z_{k}\} \cdot                                                                         \\
                          & P\{Z(\mathbf{u} + (L+1)) \leq z_{k}\}
    \end{split}
\end{align}

The separation distance between elements is $\mathbf{h}$. This definition amounts to a recursive application of Bayes' Law to determine the joint probability of the multiple-point event. In the multivariate Gaussian case, the conditional probabilities are calculated using simple indicator kriging \citep{journel1989nongaussian}. With correlated sequences, the range of correlation influences the frequencies of runs. As correlation increases, there are fewer short runs and more long ones relative to random \citep{ortiz2003characterization}.

Correlated Gaussian sequences with an arbitrary covariance structure can be easily generated using any stochastic simulation algorithm and the indicator formalism of Equation~\ref{eq:indicator}. The total number of runs and frequencies of run lengths can be determined experimentally for the multivariate Gaussian scenario. If the covariance structure of the Gaussian realizations matches that of the true one-dimensional drillhole sequence, multiple-point run-based statistics could be used to measure non-Gaussianity. This is the main idea presented in this paper. If the number or frequency of runs in the data deviates significantly from the Gaussian case, one may investigate the sequence as non-Gaussian. These measures can provide insight into domain sub-regions that exhibit non-Gaussian behaviour and warrant further investigation.

\FloatBarrier
\subsection{Distribution of Runs}
\label{subsec:03runs}

Multiple-point statistics characterize the spatial relationship between multiple points. In contrast to two-point statistics, such as the variogram, multiple-point statistics can reproduce curvilinear features and more complex ordering \citep{guardiano1993multivariate}. Runs are one-dimensional patterns or a type of multi-point statistic that can be applied to data sequences like drillholes \citep{boisvert2007multiplepoint}.

Binary sequences are generated by applying the indicator formalism to linear, one-dimensional drill strings (Figure~\ref{fig:gauss_indicators}). This transform characterizes each element in the sequence as a binary event relative to thresholds $z_{k}, \ k=1,\dots,K$. It is assumed that the elements in the sequence are equidistant; that is, the drillhole has been composited. Multiple-point configurations such as runs can then be extracted from the sequences. In practice, one may have to adapt tolerances such that statistics are inferred from approximately linear or equidistant sequence elements \citep{ortiz2003characterization}.

\begin{figure}[htb!]
    \centering
    \includegraphics[scale=0.6, max size={\textwidth}{\textheight}]{./0-Figures/03-Ch03/gauss_indicators.png}
    \caption{Indicator transform of a Gaussian \gls{RV} using the 0.1, 0.5, and 0.9 quantiles as thresholds. }
    \label{fig:gauss_indicators}
\end{figure}

Runs are calculated in a cumulative or ``overlapping'' fashion. That is, one run of 3 is also two runs of 2 and three runs of 1; Figure~\ref{fig:cumulative_runs} shows this nesting. A run of length $L$ is also $i$ runs of length $L-i+1, \ i=1,\dots,L$. This cumulative approach accounts for the dependence between overlapping runs within the sequence \citep{mood1940distribution}. Considering cumulative runs generates a histogram of run lengths that decreases as run lengths increase. This controls long runs as a long run contains elements for all shorter runs \citep{ortiz2003characterization}.

\begin{figure}[htb!]
    \centering
    \includegraphics[scale=0.4, max size={\textwidth}{\textheight}]{./0-Figures/03-Ch03/cumulative_runs.png}
    \caption{Example of lower-order runs for a single run of 3. One run of 3 is also two runs of 2 and three runs of 1.}
    \label{fig:cumulative_runs}
\end{figure}

It is interesting to note that the indicator transform results in nested runs. Runs that are above the current threshold are also above any lower threshold. Figure~\ref{fig:gauss_indicators} also illustrates this nesting where all runs above (zeros) the 0.9 quantile are nested within a run above the 0.5 quantile, which is nested within a run above the 0.1 quantile. \cite{ortiz2003characterization} uses this property of runs to simulate hierarchically as a run at one threshold can be used to condition the next threshold.

\FloatBarrier
\subsection{$\mathbf{N}$-point Connectivity Function}
\label{subsec:03npoint}

Connectivity of extreme values is commonly discussed as a shortcoming of a Gaussian \gls{RF} model \citep{journel1993entropy,journel1989nongaussian}. The maximum entropy characteristic of the Gaussian \gls{RF} model leads to maximum disorder for a given covariance structure; it does not allow for spatial correlation or connectivity of extreme quantile indicators \citep{journel1989nongaussian}. Furthermore, the nature of the bivariate Gaussian relationship leads to symmetric destructuring of the indicator variogram about the median. In practice, natural non-Gaussian distributions show asymmetric destructuring of indicator variograms \citep{vincent2021multipleindicator} and correlation need not approach zero as $z_{k}$ approaches an extreme quantile \citep{journel1989nongaussian}.

Connectivity within in sequence can be quantified by a connectivity function \citep{renard2011conditioning}. Two-point connectivity is characterized by the expected value of the product of indicators $I(\mathbf{u}; z_{k})$ and $I(\mathbf{u}+\mathbf{h}; z_{k})$. The $n\text{-point}$ connectivity function, proposed by \cite{journel1989nongaussian}, in a given direction can be generalized as the expected value of the product of $n$ indicators where the lag distance $\mathbf{h}$ is the distance between sequence elements:
\begin{equation}
    \phi_{z_{k}}(n;\mathbf{h}) = E\left\{\prod_{j=1}^{n} I(\mathbf{u} + (j-1)\mathbf{h}; z_{k})\right\}
    \label{eq:npt}
\end{equation}

The $n\text{-point}$ connectivity function describes the probability of $n$ successive elements in the sequence being jointly \emph{below} the threshold $z_{k}$. To consider the probability of being jointly \emph{above} the threshold $z_{k}$, Equation \ref{eq:npt} would be modified to:
\begin{equation}
    \phi_{z_{k}}(n;\mathbf{h}) = E\left\{\prod_{j=1}^{n} 1 - I(\mathbf{u} + (j-1)\mathbf{h}; z_{k})\right\}
    \label{eq:npt2}
\end{equation}

\cite{journel1989nongaussian} show that the $n\text{-point}$ connectivity function for a realization of an \gls{RV} with connected extreme values is much less than the true connectivity. Figure~\ref{fig:npt_connectivity} shows an example of an $n\text{-point}$ connectivity function for a non-Gaussian one-dimensional string data (blue) and a Gaussian realization of the same string (orange). The Gaussian realization is generated with LU matrix simulation and has the same covariance structure as the original data string. Figure~\ref{fig:npt_connectivity} shows the probability of connected steps within the Gaussian realization is less than the true data for the first 20 steps.

\begin{figure}[htb!]
    \centering
    \includegraphics[scale=0.7, max size={\textwidth}{\textheight}]{./0-Figures/03-Ch03/npt_connectivity.png}
    \caption{$n$-Point connectivity function for a string of non-Gaussian data (reg) and the expected value of Gaussian realizations (gray) with the same covariance structure.}
    \label{fig:npt_connectivity}
\end{figure}

As properties of the Gaussian \gls{RF} model lead to maximum disorder, one could use a connectivity measure to assess non-Gaussianity in data sequences. The idea is that a Gaussian \gls{RV} would have a different distribution of runs relative to a non-Gaussian \gls{RV}. The multi-point patterns' spatial arrangement would differ depending on the underlying \gls{RV}. \Glspl{RV} with less disorder or more connectivity will have fewer but longer runs. This connectivity concept applies to sequences with structured extreme values that are not well fit by a Gaussian distribution. It seems reasonable to assume there is some degree of connectivity of extremes in mineral systems; the underlying spatial phenomena are not entirely disorganized.

\FloatBarrier
\subsection{Measures of Non‐Gaussianity}
\label{subsec:03ngmeasures}

Four measures of non-Gaussianity are proposed based on the concepts of runs and connectivity within drill string sequences:
\begin{enumerate}[noitemsep]
    \item Total Runs: the total number of unique runs above and below a particular threshold.
    \item Run Length Frequencies: the frequency of cumulative run lengths (Figure~\ref{fig:cumulative_runs}) above or below a particular threshold.
    \item $N$-Point connectivity: the number of connected steps above and below a particular threshold.
    \item Change of Support: the relationship between continuous variance and scale.
\end{enumerate}

The first measure calculates the total number of cumulative runs within the indicator transformed sequence. As connectivity within the sequence increases, there are fewer but longer \emph{total} runs. This connectivity translates to a greater number of \emph{cumulative} runs as each longer run contains $\{L-i+1, \ i=1,\dots,L\}$ lower-order runs. It is expected that a non-Gaussian sequence with connectivity of extremes that cannot be characterized well by a Gaussian RF will exhibit a greater number of cumulative runs than a Gaussian sequence.The second measure calculates the cumulative run-length frequencies within the indicator transformed sequence. Increased connectivity within the sequence leads to fewer but longer run lengths. Similar to the first measure of total runs, it is expected that a non-Gaussian sequence with connectivity of extremes will exhibit a greater frequency of longer run lengths. The nature of cumulative run lengths leads to a histogram of lengths that decreases as run-length increases, facilitating a more straightforward comparison of distributions. The third measure is the $n\text{-point}$ connectivity of the indicator transformed sequence. The $n\text{-point}$ connectivity function quantifies the probability of $n$ successive elements in the sequence being below (or optionally above) the indicator thresholds. Only elements below the threshold contribute to the probability in Equation~\ref{eq:npt}. As connectivity within the sequence increases, the probability of successive elements being jointly below the given threshold increases. This connection probability is beneficial for non-Gaussian sequences containing connected extreme values. It is expected that a highly structured non-Gaussian sequence will have a greater probability of $n$ connected steps compared to a maximum entropy Gaussian sequence as $n$ increases. This characteristic is shown in Figure~\ref{fig:npt_connectivity}. The fourth measure calculates the change of support for the original continuous variable. This measure is quantified by averaging $n$ consecutive elements within the sequence and calculating the variance. As volume increases, the variance of the elements within the sequence decreases. The idea is that if the sequence has structured or connected extreme values, the variance of the sequence should be sensitive to scale. The more structured the extremes, the greater the sensitivity to volume averaging. It is expected that a non-Gaussian sequence with connected extreme values will show a more drastic reduction in variance as scale increases compared to a maximum entropy Gaussian sequence.

The covariance structure of each sequence is calculated from the exhaustive drill string ``image''. This structure generates Gaussian realizations with the exact covariance of the original sequence. The Gaussian realizations are back-transformed to original units and transformed into indicators with Equation~\ref{eq:indicator}. Each metric is calculated for each one-dimensional data string and compared to the distribution of metrics observed from the Gaussian realizations. The deviation between the original sequence and the Gaussian distribution is used to measure non-Gaussianity. The general workflow for calculating the proposed measures of non-Gaussianity on a drillhole-by-drillhole basis is as follows:
\begin{enumerate}[noitemsep]
    \item Indicator transform all drillholes for given quantiles.
    \item Calculate cumulative runs and run-length frequencies for all thresholds for all drillholes.
    \item Calculate the $n$-point connectivity function for all thresholds for all drillholes.
    \item Down-sample the continuous variable by given scale factors and calculate the variance versus scale curve.
    \item Normal score transform all drillholes.
    \item Calculate the autocovariance matrix for each drillhole and simulate $l=1,\dots,L$ unconditional Gaussian realizations of each drillhole.
    \item Back transform Gaussian realizations to original units.
    \item Repeat steps 1-4 for each realization of each drillhole.
    \item Calculate the score for each measure as $y = \frac{z_{dh}-\mu_{r}}{\sigma_{r}}$ where $z_{dh}$ is the measure from the original drillhole and $\mu_{r}$ and $\sigma_{r}$ are the mean and standard deviation of the \emph{distribution of measures} from the realizations, respectively.
    \item The final $y$ score is taken as $\lvert y \rvert$ such that only the magnitude, not the sign, is considered.
\end{enumerate}

The score $y$ measures how many standard deviations away from the Gaussian distribution the original drillhole is. Figure~\ref{fig:score} illustrates $y$-score calculation. This score indicates the appropriateness of a Gaussian random function model as the realizations are generated with the exact covariance structure of the original drillhole—any drillhole with a $y$ value greater than 2.5 exhibits highly non-Gaussian behaviour.

\begin{figure}[htb!]
    \centering
    \includegraphics[scale=0.7, max size={\textwidth}{\textheight}]{./0-Figures/03-Ch03/score.png}
    \caption{Schematic illustrating the calculation of the non-Gaussian Score $y$ where $z_{dh}$ is the metric from the drillhole, and $\mu_{r}$ and $\sigma_{r}$ are the mean and standard deviation of the Gaussian distribution.}
    \label{fig:score}
\end{figure}

Consider a \gls{2D} synthetic example generated from an image of a meandering river system. The RGB colour channels are averaged to generate a grey scale image which is then normalized $\in [0,1]$. The main river channels show highly structured high values relative to the background flood plane and abandoned channels (Figure \ref{fig:non_gauss4_grid}). These features are a natural example of non-Gaussian characteristics in geospatial data. The image is ``drilled'' resulting in 10 drill strings to calculate measures of non-Gaussianity.

\begin{figure}[htb!]
    \centering
    \includegraphics[scale=0.5, max size={\textwidth}{\textheight}]{./0-Figures/03-Ch03/non_gauss4_grid.png}
    \caption{Image of a meandering river system sampled in ten locations resulting in sequences of pixel data.}
    \label{fig:non_gauss4_grid}
\end{figure}

Table \ref{tab:ng_metrics} shows the expected non-Gaussian scores for each sequence across 100 realizations for the 0.1 and 0.9 quantile indicator transforms. As the highly structured regions are predominantly high-grade, the 0.1 quantile indicators do not show significant non-Gaussianity.


\begin{table}[!htb]
    \centering
    \caption{Non-Gaussian metrics calculated for 10 drillholes considering the 0.1 and 0.9 quantile indicator transforms. $y$-scores $\geq 2.5$ are considered strongly non-Gaussian.}
    \resizebox{1\width}{!}{\input{0-Tables/ng_metrics.tex}}
    \label{tab:ng_metrics}
\end{table}


\FloatBarrier
\section{Network Methodology}
\label{sec:method}

\begin{enumerate}
    \item Latent variables
    \item Gaussian mixture models
    \item Parameter inference
    \item Imputation
    \item
\end{enumerate}


\FloatBarrier
\section{Discussion}
\label{sec:discuss03}